<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CREDIT MATRIX</title>
    <style>
/* ============================================
   CREDIT MATRIX - MATRIX / CYBER Theme
   ============================================ */

/* --- CSS Variables --- */
:root {
    --bg-primary: #000000;
    --bg-secondary: #030303;
    --bg-card: #0a0f0a;
    --bg-card-hover: #0d170d;
    --bg-input: #020502;
    --border-color: #0a3a0a;
    --border-glow: #00ff4122;
    --text-primary: #00ff41;
    --text-secondary: #00cc33;
    --text-muted: #006622;
    --accent-cyan: #00ff41;
    --accent-blue: #00cc33;
    --accent-purple: #00ffcc;
    --accent-violet: #008f11;
    --accent-green: #00e676;
    --accent-red: #ff0040;
    --accent-amber: #ffcc00;
    --accent-pink: #39ff14;
    --glow-cyan: 0 0 15px #00ff4133, 0 0 30px #00ff4111;
    --glow-purple: 0 0 15px #00ffcc33, 0 0 30px #00ffcc11;
    --sidebar-width: 260px;
    --topbar-height: 64px;
    --font-display: 'Orbitron', monospace;
    --font-heading: 'Share Tech Mono', monospace;
    --font-body: 'Share Tech Mono', monospace;
    --radius: 4px;
    --radius-sm: 2px;
    --radius-lg: 6px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* --- Reset & Base --- */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    scroll-behavior: smooth;
}

body {
    font-family: var(--font-body);
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
    line-height: 1.6;
}

/* --- Animated Background --- */
.bg-grid {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image:
        linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
}

.bg-particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
}

.particle {
    position: absolute;
    width: 2px;
    height: 2px;
    background: var(--accent-cyan);
    border-radius: 50%;
    opacity: 0;
    animation: particleFloat 8s infinite;
}

@keyframes particleFloat {
    0% { opacity: 0; transform: translateY(100vh) scale(0); }
    10% { opacity: 0.6; }
    90% { opacity: 0.6; }
    100% { opacity: 0; transform: translateY(-10vh) scale(1); }
}

/* --- Scrollbar --- */
::-webkit-scrollbar {
    width: 6px;
}
::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}
::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
    background: var(--accent-cyan);
}

/* --- Sidebar --- */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: var(--sidebar-width);
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    z-index: 100;
    transition: transform 0.3s ease;
}

.sidebar-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border-color);
}

.logo-icon svg {
    width: 40px;
    height: 40px;
}

.logo-text {
    display: flex;
    flex-direction: column;
}

.logo-title {
    font-family: var(--font-display);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--accent-cyan);
}

.logo-subtitle {
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 400;
    letter-spacing: 3px;
    color: var(--accent-purple);
}

.nav-links {
    flex: 1;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: var(--transition);
}

.nav-link svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.nav-link:hover {
    color: var(--text-primary);
    background: rgba(0, 255, 65, 0.05);
}

.nav-link.active {
    color: var(--accent-cyan);
    background: rgba(0, 255, 65, 0.1);
    border: 1px solid rgba(0, 255, 65, 0.15);
}

.sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-color);
}

.system-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-muted);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent-green);
    box-shadow: 0 0 8px var(--accent-green);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* --- Main Content --- */
.main-content {
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    position: relative;
    z-index: 1;
}

/* --- Top Bar --- */
.top-bar {
    height: var(--topbar-height);
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 0 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 50;
}

.menu-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    padding: 4px;
}

.menu-toggle svg {
    width: 24px;
    height: 24px;
}

.search-bar {
    flex: 1;
    max-width: 480px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    border-radius: 24px;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.search-bar:focus-within {
    border-color: var(--accent-cyan);
    box-shadow: var(--glow-cyan);
}

.search-bar svg {
    width: 18px;
    height: 18px;
    color: var(--text-muted);
    flex-shrink: 0;
}

.search-bar input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text-primary);
    font-size: 14px;
    font-family: var(--font-body);
}

.search-bar input::placeholder {
    color: var(--text-muted);
}

.top-bar-actions {
    display: flex;
    gap: 8px;
}

.btn-icon {
    background: none;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.btn-icon svg {
    width: 18px;
    height: 18px;
}

.btn-icon:hover {
    border-color: var(--accent-cyan);
    color: var(--accent-cyan);
}

/* --- Pages --- */
.page {
    display: none;
    padding: 32px;
    animation: fadeIn 0.3s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.page-header {
    margin-bottom: 32px;
}

.page-header h1 {
    font-family: var(--font-heading);
    font-size: 32px;
    font-weight: 600;
    letter-spacing: 1px;
    background: linear-gradient(135deg, var(--text-primary), var(--accent-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.page-desc {
    color: var(--text-secondary);
    font-size: 14px;
    margin-top: 4px;
}

.page-header .btn-primary {
    margin-top: 12px;
}

/* --- Stats Grid --- */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: var(--transition);
}

.stat-card:hover {
    border-color: rgba(0, 255, 65, 0.2);
    transform: translateY(-2px);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon svg {
    width: 24px;
    height: 24px;
}

.stat-icon.blue {
    background: rgba(0, 255, 65, 0.1);
    color: var(--accent-cyan);
}

.stat-icon.purple {
    background: rgba(0, 255, 204, 0.1);
    color: var(--accent-purple);
}

.stat-icon.green {
    background: rgba(0, 255, 204, 0.1);
    color: var(--accent-green);
}

.stat-icon.amber {
    background: rgba(255, 204, 0, 0.1);
    color: var(--accent-amber);
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* --- Cards --- */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 24px;
}

.card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-header h3 {
    font-family: var(--font-heading);
    font-size: 18px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.card-body {
    padding: 20px;
}

.header-actions {
    display: flex;
    gap: 8px;
}

/* --- Dashboard Grid --- */
.dashboard-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

/* --- Buttons --- */
.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-primary:hover {
    box-shadow: var(--glow-cyan);
    transform: translateY(-1px);
}

.btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: linear-gradient(135deg, var(--accent-purple), var(--accent-violet));
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.btn-secondary:hover {
    box-shadow: var(--glow-purple);
    transform: translateY(-1px);
}

.btn-sm {
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    background: rgba(0, 255, 65, 0.1);
    color: var(--accent-cyan);
    border: 1px solid rgba(0, 255, 65, 0.2);
    border-radius: 6px;
    cursor: pointer;
    transition: var(--transition);
    font-family: var(--font-body);
}

.btn-sm:hover {
    background: rgba(0, 255, 65, 0.2);
}

.btn-outline {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn-outline:hover {
    border-color: var(--accent-cyan);
    color: var(--accent-cyan);
    background: rgba(0, 255, 65, 0.05);
}

.btn-outline-light {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
}

.btn-outline-light:hover {
    border-color: var(--accent-cyan);
    color: var(--accent-cyan);
}

.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    cursor: pointer;
    margin-bottom: 8px;
    font-family: var(--font-body);
    transition: var(--transition);
}

.btn-back:hover {
    color: var(--accent-cyan);
}

/* --- Action Buttons (Dashboard) --- */
.action-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 14px;
    font-family: var(--font-body);
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 8px;
}

.action-btn:last-child {
    margin-bottom: 0;
}

.action-btn svg {
    width: 20px;
    height: 20px;
    color: var(--accent-cyan);
}

.action-btn:hover {
    border-color: var(--accent-cyan);
    background: rgba(0, 255, 65, 0.05);
}

/* --- Empty State --- */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
}

.empty-state h3 {
    font-family: var(--font-heading);
    font-size: 20px;
    margin-top: 16px;
    color: var(--text-primary);
}

.empty-state p {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 8px 0 20px;
}

.empty-state-small {
    padding: 20px;
    text-align: center;
}

.empty-state-small p {
    color: var(--text-muted);
    font-size: 13px;
}

/* --- Drop Zone --- */
.drop-zone-container {
    margin: 24px 0;
}

.drop-zone {
    position: relative;
    border-radius: var(--radius-lg);
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    background: var(--bg-card);
    overflow: hidden;
}

.drop-zone-border {
    position: absolute;
    inset: 0;
    border-radius: var(--radius-lg);
    border: 2px dashed var(--border-color);
    pointer-events: none;
    transition: var(--transition);
}

.drop-zone:hover .drop-zone-border,
.drop-zone.drag-over .drop-zone-border {
    border-color: var(--accent-cyan);
    box-shadow: var(--glow-cyan);
}

.drop-zone.drag-over {
    background: rgba(0, 255, 65, 0.05);
}

.drop-zone-inner {
    position: relative;
    z-index: 1;
}

.drop-icon {
    margin-bottom: 20px;
}

.drop-icon svg {
    width: 80px;
    height: 80px;
    filter: drop-shadow(0 0 20px rgba(0, 255, 65, 0.3));
}

.drop-title {
    font-family: var(--font-heading);
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.drop-subtitle {
    color: var(--accent-cyan);
    font-size: 14px;
    margin-bottom: 4px;
}

.drop-hint {
    color: var(--text-muted);
    font-size: 12px;
    margin-bottom: 20px;
}

.bureau-badges {
    display: flex;
    justify-content: center;
    gap: 12px;
}

.bureau-badge {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.bureau-badge.experian {
    background: rgba(0, 204, 51, 0.1);
    color: #00cc33;
    border: 1px solid rgba(0, 204, 51, 0.2);
}

.bureau-badge.equifax {
    background: rgba(255, 0, 64, 0.1);
    color: #ff0040;
    border: 1px solid rgba(255, 0, 64, 0.2);
}

.bureau-badge.transunion {
    background: rgba(0, 255, 204, 0.1);
    color: #00ffcc;
    border: 1px solid rgba(0, 255, 204, 0.2);
}

/* --- Upload Progress --- */
.upload-progress .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.progress-title {
    font-family: var(--font-heading);
    font-size: 16px;
    color: var(--text-primary);
}

.progress-percent {
    font-family: var(--font-display);
    font-size: 14px;
    color: var(--accent-cyan);
}

.progress-bar {
    height: 4px;
    background: var(--bg-input);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 20px;
}

.progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
    border-radius: 2px;
    transition: width 0.3s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
}

.progress-step {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-muted);
}

.progress-step.active {
    color: var(--accent-cyan);
}

.progress-step.done {
    color: var(--accent-green);
}

.step-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border-color);
}

.progress-step.active .step-dot {
    background: var(--accent-cyan);
    box-shadow: 0 0 8px var(--accent-cyan);
}

.progress-step.done .step-dot {
    background: var(--accent-green);
}

/* --- Form Elements --- */
.form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px 14px;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 14px;
    font-family: var(--font-body);
    outline: none;
    transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: var(--accent-cyan);
    box-shadow: var(--glow-cyan);
}

.form-group select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='%238888aa' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 36px;
}

.form-group select option {
    background: var(--bg-card);
    color: var(--text-primary);
}

.client-select-row {
    display: flex;
    gap: 16px;
    align-items: flex-end;
}

.new-client-form {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-color);
}

/* --- Badges --- */
.badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.badge-info {
    background: rgba(0, 255, 65, 0.1);
    color: var(--accent-cyan);
}

.badge-danger {
    background: rgba(255, 0, 64, 0.1);
    color: var(--accent-red);
}

.badge-warning {
    background: rgba(255, 204, 0, 0.1);
    color: var(--accent-amber);
}

.badge-success {
    background: rgba(0, 255, 204, 0.1);
    color: var(--accent-green);
}

/* --- Accounts List --- */
.accounts-filter {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    background: var(--bg-input);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: var(--transition);
    font-family: var(--font-body);
}

.filter-btn.active,
.filter-btn:hover {
    background: rgba(0, 255, 65, 0.1);
    color: var(--accent-cyan);
    border-color: rgba(0, 255, 65, 0.3);
}

.account-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    transition: var(--transition);
}

.account-item:hover {
    border-color: rgba(0, 255, 65, 0.2);
}

.account-item.deselected {
    opacity: 0.4;
}

.account-checkbox {
    position: relative;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.account-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    appearance: none;
    background: var(--bg-primary);
    border: 2px solid var(--border-color);
    border-radius: 4px;
    cursor: pointer;
    transition: var(--transition);
}

.account-checkbox input[type="checkbox"]:checked {
    background: var(--accent-cyan);
    border-color: var(--accent-cyan);
}

.account-checkbox input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.account-details {
    flex: 1;
    min-width: 0;
}

.account-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.account-meta {
    display: flex;
    gap: 16px;
    margin-top: 4px;
    font-size: 12px;
    color: var(--text-secondary);
}

.account-type-badge {
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    flex-shrink: 0;
}

.account-type-badge.collection {
    background: rgba(255, 0, 64, 0.1);
    color: var(--accent-red);
}

.account-type-badge.late_payment {
    background: rgba(255, 204, 0, 0.1);
    color: var(--accent-amber);
}

.account-type-badge.charge_off {
    background: rgba(57, 255, 20, 0.1);
    color: var(--accent-pink);
}

.account-type-badge.public_record {
    background: rgba(0, 255, 204, 0.1);
    color: var(--accent-purple);
}

.account-type-badge.repossession {
    background: rgba(255, 0, 64, 0.15);
    color: #ff4040;
}

.account-type-badge.negative {
    background: rgba(255, 0, 64, 0.1);
    color: var(--accent-red);
}

.accounts-summary {
    margin-top: 16px;
    padding: 12px 16px;
    background: rgba(0, 255, 65, 0.05);
    border: 1px solid rgba(0, 255, 65, 0.1);
    border-radius: var(--radius-sm);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
}

.accounts-summary .selected-count {
    color: var(--accent-cyan);
    font-weight: 600;
}

/* --- Template Grid --- */
.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
}

.template-card {
    padding: 20px;
    background: var(--bg-input);
    border: 2px solid var(--border-color);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.template-card:hover {
    border-color: rgba(0, 255, 65, 0.3);
    transform: translateY(-2px);
}

.template-card.selected {
    border-color: var(--accent-cyan);
    box-shadow: var(--glow-cyan);
    background: rgba(0, 255, 65, 0.05);
}

.template-card.selected::after {
    content: '';
    position: absolute;
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    background: var(--accent-cyan);
    border-radius: 50%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 12 10 16 18 8'/%3E%3C/svg%3E");
    background-size: 16px;
    background-repeat: no-repeat;
    background-position: center;
}

.template-card h4 {
    font-family: var(--font-heading);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.template-card p {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
}

.template-card .template-tag {
    display: inline-block;
    margin-top: 12px;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
    background: rgba(0, 255, 204, 0.1);
    color: var(--accent-purple);
}

/* --- Templates Showcase Page --- */
.templates-showcase {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
}

.showcase-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 24px;
    transition: var(--transition);
}

.showcase-card:hover {
    border-color: rgba(0, 255, 65, 0.2);
    transform: translateY(-2px);
}

.showcase-card h3 {
    font-family: var(--font-heading);
    font-size: 20px;
    margin-bottom: 8px;
}

.showcase-card p {
    color: var(--text-secondary);
    font-size: 13px;
    margin-bottom: 16px;
    line-height: 1.6;
}

.showcase-card .preview-snippet {
    padding: 12px;
    background: var(--bg-input);
    border-radius: var(--radius-sm);
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.6;
    max-height: 120px;
    overflow: hidden;
    position: relative;
    font-family: 'Courier New', monospace;
}

.showcase-card .preview-snippet::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, var(--bg-input));
}

/* --- Generate Section --- */
.generate-section {
    text-align: center;
    padding: 32px;
    margin-top: 8px;
}

.generate-info {
    margin-bottom: 20px;
}

.generate-info p {
    color: var(--text-secondary);
    font-size: 14px;
}

.bureau-targets {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 12px;
}

.bureau-target {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
}

.bureau-target.experian {
    background: rgba(0, 204, 51, 0.1);
    color: #00cc33;
}

.bureau-target.equifax {
    background: rgba(255, 0, 64, 0.1);
    color: #ff0040;
}

.bureau-target.transunion {
    background: rgba(0, 255, 204, 0.1);
    color: #00ffcc;
}

.btn-generate {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 40px;
    font-size: 16px;
    font-weight: 700;
    font-family: var(--font-heading);
    letter-spacing: 1px;
    color: #fff;
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.btn-generate::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(0, 255, 65, 0.3), 0 0 60px rgba(0, 255, 204, 0.2);
}

.btn-generate:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* --- Letter Preview --- */
.letter-tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 4px;
}

.letter-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 600;
    font-family: var(--font-body);
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: var(--transition);
}

.letter-tab.active {
    background: rgba(0, 255, 65, 0.1);
    color: var(--accent-cyan);
}

.letter-tab:hover:not(.active) {
    background: rgba(255,255,255,0.03);
}

.tab-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.tab-dot.experian { background: #00cc33; }
.tab-dot.equifax { background: #ff0040; }
.tab-dot.transunion { background: #00ffcc; }

.letter-actions-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.letter-paper {
    background: #fff;
    color: #111;
    padding: 60px;
    border-radius: var(--radius);
    min-height: 800px;
    font-family: 'Times New Roman', serif;
    font-size: 14px;
    line-height: 1.7;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    white-space: pre-wrap;
    max-width: 850px;
    margin: 0 auto;
}

.letter-paper .letter-header {
    margin-bottom: 30px;
}

.letter-paper .letter-body p {
    margin-bottom: 14px;
}

.letter-paper .account-table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    font-size: 12px;
}

.letter-paper .account-table th {
    background: #0a0f0a;
    padding: 8px 12px;
    text-align: left;
    font-weight: 700;
    border: 1px solid #0a3a0a;
}

.letter-paper .account-table td {
    padding: 8px 12px;
    border: 1px solid #0a3a0a;
}

/* --- Clients Grid --- */
.clients-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
}

.search-inline {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    flex: 1;
    max-width: 400px;
    transition: var(--transition);
}

.search-inline:focus-within {
    border-color: var(--accent-cyan);
}

.search-inline svg {
    width: 18px;
    height: 18px;
    color: var(--text-muted);
}

.search-inline input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text-primary);
    font-size: 14px;
    font-family: var(--font-body);
}

.view-toggle {
    display: flex;
    gap: 4px;
    background: var(--bg-input);
    border-radius: var(--radius-sm);
    padding: 3px;
    border: 1px solid var(--border-color);
}

.view-btn {
    padding: 6px 10px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-radius: 6px;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
}

.view-btn.active {
    background: rgba(0, 255, 65, 0.1);
    color: var(--accent-cyan);
}

.clients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
}

.clients-grid.list-view {
    grid-template-columns: 1fr;
}

.client-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: var(--transition);
}

.client-card:hover {
    border-color: rgba(0, 255, 65, 0.3);
    transform: translateY(-2px);
}

.client-card-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 12px;
}

.client-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
}

.client-card-name {
    font-size: 16px;
    font-weight: 600;
}

.client-card-email {
    font-size: 12px;
    color: var(--text-secondary);
}

.client-card-stats {
    display: flex;
    gap: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.client-stat {
    display: flex;
    flex-direction: column;
}

.client-stat-value {
    font-family: var(--font-display);
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-cyan);
}

.client-stat-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* list view overrides */
.clients-grid.list-view .client-card {
    display: flex;
    align-items: center;
    gap: 20px;
}

.clients-grid.list-view .client-card-header {
    margin-bottom: 0;
    flex: 1;
}

.clients-grid.list-view .client-card-stats {
    border-top: none;
    padding-top: 0;
    border-left: 1px solid var(--border-color);
    padding-left: 20px;
}

/* --- Client Detail --- */
.client-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

.client-info-card .info-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.client-info-card .info-row:last-child {
    border-bottom: none;
}

.client-info-card .info-label {
    color: var(--text-secondary);
}

.client-info-card .info-value {
    font-weight: 500;
}

.file-item, .letter-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    transition: var(--transition);
}

.file-item:hover, .letter-item:hover {
    border-color: rgba(0, 255, 65, 0.2);
}

.file-info, .letter-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.file-info svg, .letter-info svg {
    width: 20px;
    height: 20px;
    color: var(--accent-cyan);
}

.file-name, .letter-name {
    font-size: 13px;
    font-weight: 500;
}

.file-date, .letter-date {
    font-size: 11px;
    color: var(--text-muted);
}

/* --- Disputes Page --- */
.disputes-list .dispute-group {
    margin-bottom: 24px;
}

.dispute-group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius) var(--radius) 0 0;
}

.dispute-group-header h3 {
    font-family: var(--font-heading);
    font-size: 16px;
}

.dispute-group-body {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    padding: 16px 20px;
}

/* --- Modal --- */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    font-family: var(--font-heading);
    font-size: 20px;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 24px;
    cursor: pointer;
    padding: 0 4px;
    transition: var(--transition);
}

.modal-close:hover {
    color: var(--accent-red);
}

.modal-body {
    padding: 24px;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
}

/* --- Toast --- */
.toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 300;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.toast {
    padding: 14px 20px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 14px;
    min-width: 280px;
    animation: toastIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.toast.success {
    border-color: var(--accent-green);
}

.toast.error {
    border-color: var(--accent-red);
}

.toast.info {
    border-color: var(--accent-cyan);
}

@keyframes toastIn {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes toastOut {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(30px); }
}

/* --- Activity List --- */
.activity-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 13px;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.activity-dot.upload { background: var(--accent-cyan); }
.activity-dot.letter { background: var(--accent-purple); }
.activity-dot.client { background: var(--accent-green); }

.activity-text {
    flex: 1;
    color: var(--text-secondary);
}

.activity-text strong {
    color: var(--text-primary);
}

.activity-time {
    font-size: 11px;
    color: var(--text-muted);
}

/* --- Responsive --- */
@media (max-width: 1024px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    .client-detail-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }
    .sidebar.open {
        transform: translateX(0);
    }
    .main-content {
        margin-left: 0;
    }
    .menu-toggle {
        display: block;
    }
    .page {
        padding: 20px;
    }
    .drop-zone {
        padding: 40px 20px;
    }
    .form-row {
        flex-direction: column;
    }
    .letter-paper {
        padding: 30px;
    }
    .letter-actions-bar {
        flex-direction: column;
    }
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    .clients-grid {
        grid-template-columns: 1fr;
    }
    .template-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    .bureau-badges {
        flex-direction: column;
        align-items: center;
    }
    .letter-tabs {
        flex-direction: column;
    }
}

/* ============================================
   CREDIT MATRIX - Cyber Effects
   ============================================ */

/* --- Matrix Rain Canvas --- */
#matrixCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    opacity: 0.12;
}

/* --- Scanlines Overlay --- */
.scanlines {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 65, 0.01) 2px,
        rgba(0, 255, 65, 0.01) 4px
    );
}

/* --- Matrix Grid Override --- */
.bg-grid {
    background-image:
        linear-gradient(rgba(0, 255, 65, 0.035) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 65, 0.035) 1px, transparent 1px) !important;
    background-size: 40px 40px !important;
}

/* --- Glitch Title Effect --- */
@keyframes textGlitch {
    0%, 88%, 100% { text-shadow: none; transform: none; }
    90% { text-shadow: 2px 0 #00ff41, -2px 0 #ff0040; transform: skew(-0.5deg); }
    92% { text-shadow: -2px 0 #00ffcc, 2px 0 #ff0040; transform: skew(0.5deg); }
    94% { text-shadow: 1px 0 #00ff41; transform: none; }
}
.logo-title { animation: textGlitch 5s infinite !important; }

/* --- Matrix Border Pulse --- */
@keyframes matrixGlow {
    0%, 100% { box-shadow: 0 0 5px rgba(0,255,65,0.05); }
    50% { box-shadow: 0 0 15px rgba(0,255,65,0.15), 0 0 30px rgba(0,255,65,0.05); }
}
.stat-card:hover, .client-card:hover, .template-card:hover, .showcase-card:hover {
    animation: matrixGlow 2s infinite !important;
}

/* --- Input Focus Glow --- */
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    box-shadow: 0 0 10px rgba(0,255,65,0.3), inset 0 0 3px rgba(0,255,65,0.1) !important;
}
.search-bar:focus-within, .search-inline:focus-within {
    box-shadow: 0 0 10px rgba(0,255,65,0.3) !important;
}

/* --- Stat Icon Matrix Colors --- */
.stat-icon.blue { background: rgba(0,255,65,0.1) !important; color: #00ff41 !important; }
.stat-icon.purple { background: rgba(0,255,204,0.1) !important; color: #00ffcc !important; }
.stat-icon.green { background: rgba(0,230,118,0.1) !important; color: #00e676 !important; }
.stat-icon.amber { background: rgba(255,204,0,0.1) !important; color: #ffcc00 !important; }

/* --- Bureau Colors Matrix --- */
.tab-dot.experian { background: #00ff41 !important; }
.tab-dot.equifax { background: #ff0040 !important; }
.tab-dot.transunion { background: #00ffcc !important; }

.bureau-badge.experian, .bureau-target.experian {
    background: rgba(0,255,65,0.1) !important; color: #00ff41 !important;
    border-color: rgba(0,255,65,0.25) !important;
}
.bureau-badge.equifax, .bureau-target.equifax {
    background: rgba(255,0,64,0.1) !important; color: #ff0040 !important;
    border-color: rgba(255,0,64,0.25) !important;
}
.bureau-badge.transunion, .bureau-target.transunion {
    background: rgba(0,255,204,0.1) !important; color: #00ffcc !important;
    border-color: rgba(0,255,204,0.25) !important;
}

/* --- Activity Dots --- */
.activity-dot.upload { background: #00ff41 !important; }
.activity-dot.letter { background: #00ffcc !important; }
.activity-dot.client { background: #00e676 !important; }

/* --- Client Avatar --- */
.client-avatar { background: linear-gradient(135deg, #00ff41, #00ffcc) !important; color: #000 !important; }

/* --- Account Type Badges Matrix --- */
.account-type-badge.collection { background: rgba(255,0,64,0.15) !important; color: #ff0040 !important; }
.account-type-badge.late_payment { background: rgba(255,204,0,0.15) !important; color: #ffcc00 !important; }
.account-type-badge.charge_off { background: rgba(57,255,20,0.15) !important; color: #39ff14 !important; }
.account-type-badge.public_record { background: rgba(0,255,204,0.15) !important; color: #00ffcc !important; }
.account-type-badge.repossession { background: rgba(255,64,64,0.15) !important; color: #ff4040 !important; }
.account-type-badge.negative { background: rgba(255,0,64,0.15) !important; color: #ff0040 !important; }

/* --- Letter Paper (dark theme preview) --- */
.letter-paper {
    background: #050505 !important;
    color: #00ff41 !important;
    border: 1px solid #0a3a0a !important;
    box-shadow: 0 0 30px rgba(0,255,65,0.1), inset 0 0 60px rgba(0,0,0,0.5) !important;
    font-family: 'Share Tech Mono', 'Courier New', monospace !important;
}

/* --- Generate Button Matrix --- */
.btn-generate {
    background: linear-gradient(135deg, #00ff41, #00ffcc) !important;
    color: #000 !important;
    font-weight: 800 !important;
    letter-spacing: 2px !important;
    text-transform: uppercase !important;
}
.btn-generate:hover {
    box-shadow: 0 0 30px rgba(0,255,65,0.4), 0 0 60px rgba(0,255,204,0.2) !important;
}

/* --- Buttons Matrix --- */
.btn-primary {
    background: linear-gradient(135deg, #00ff41, #00cc33) !important;
    color: #000 !important;
    font-weight: 700 !important;
}
.btn-secondary {
    background: linear-gradient(135deg, #00ffcc, #008f11) !important;
    color: #000 !important;
    font-weight: 700 !important;
}

/* --- Checkbox Matrix --- */
.account-checkbox input[type="checkbox"]:checked {
    background: #00ff41 !important;
    border-color: #00ff41 !important;
}
.account-checkbox input[type="checkbox"]:checked::after {
    border-color: #000 !important;
}

/* --- Toast Matrix --- */
.toast { background: #050505 !important; border-color: #0a3a0a !important; }
.toast.success { border-color: #00ff41 !important; }
.toast.error { border-color: #ff0040 !important; }
.toast.info { border-color: #00ffcc !important; }

/* --- Template Tag --- */
.template-card .template-tag {
    background: rgba(0,255,204,0.1) !important;
    color: #00ffcc !important;
}

/* --- Selected Template Checkmark --- */
.template-card.selected::after {
    background: #00ff41 !important;
}

/* --- Page Header Gradient --- */
.page-header h1 {
    background: linear-gradient(135deg, #00ff41, #00ffcc) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
    text-transform: uppercase !important;
    letter-spacing: 2px !important;
}

/* --- Sidebar Active Link --- */
.nav-link.active {
    color: #00ff41 !important;
    background: rgba(0,255,65,0.08) !important;
    border: 1px solid rgba(0,255,65,0.15) !important;
}

/* --- Modal Matrix --- */
.modal { background: #050505 !important; border-color: #0a3a0a !important; }
.modal-overlay { background: rgba(0,0,0,0.85) !important; }

/* --- Scrollbar Matrix --- */
::-webkit-scrollbar-track { background: #000 !important; }
::-webkit-scrollbar-thumb { background: #0a3a0a !important; }
::-webkit-scrollbar-thumb:hover { background: #00ff41 !important; }

/* --- Particle Override --- */
.particle { background: #00ff41 !important; }

/* --- Progress Bar Matrix --- */
.progress-fill {
    background: linear-gradient(90deg, #00ff41, #00ffcc) !important;
}

/* --- Select Dropdown Arrow --- */
.form-group select {
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='%2300ff41' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") !important;
}

/* --- Showcase Preview Snippet --- */
.showcase-card .preview-snippet {
    font-family: 'Share Tech Mono', 'Courier New', monospace !important;
    color: #006622 !important;
    background: #020502 !important;
}
.showcase-card .preview-snippet::after {
    background: linear-gradient(transparent, #020502) !important;
}

/* --- Badge variants --- */
.badge-info { background: rgba(0,255,65,0.1) !important; color: #00ff41 !important; }
.badge-danger { background: rgba(255,0,64,0.1) !important; color: #ff0040 !important; }
.badge-warning { background: rgba(255,204,0,0.1) !important; color: #ffcc00 !important; }
.badge-success { background: rgba(0,230,118,0.1) !important; color: #00e676 !important; }


/* Custom template badge */
.badge-custom {
    background: rgba(0, 255, 65, 0.15);
    color: #00ff41;
    border: 1px solid #00ff4144;
}
.template-card.custom-template {
    border-color: #00ff4133;
}
.template-card.custom-template.selected {
    border-color: #00ff41;
    box-shadow: 0 0 20px #00ff4133;
}
.tag-custom {
    background: rgba(0, 255, 65, 0.15) !important;
    color: #00ff41 !important;
}
</style>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Matrix Rain -->
    <canvas id="matrixCanvas"></canvas>
    <div class="scanlines"></div>
    <!-- Animated Background -->
    <div class="bg-grid"></div>
    <div class="bg-particles" id="particles"></div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon">
                <svg viewBox="0 0 40 40" fill="none" width="40" height="40">
                    <rect x="2" y="3" width="36" height="28" rx="3" stroke="url(#mGrad)" stroke-width="1.5"/>
                    <line x1="8" y1="11" x2="22" y2="11" stroke="#00ff41" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="8" y1="17" x2="30" y2="17" stroke="#00ff41" stroke-width="1.5" stroke-linecap="round" opacity="0.7"/>
                    <line x1="8" y1="23" x2="16" y2="23" stroke="#00ff41" stroke-width="1.5" stroke-linecap="round" opacity="0.4"/>
                    <rect x="18" y="21" width="2" height="4" fill="#00ff41" opacity="0.9"/>
                    <line x1="14" y1="31" x2="26" y2="31" stroke="url(#mGrad)" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="20" y1="31" x2="20" y2="35" stroke="url(#mGrad)" stroke-width="1.5"/>
                    <line x1="12" y1="35" x2="28" y2="35" stroke="url(#mGrad)" stroke-width="1.5" stroke-linecap="round"/>
                    <defs>
                        <linearGradient id="mGrad" x1="0" y1="0" x2="40" y2="40">
                            <stop stop-color="#00ff41"/>
                            <stop offset="1" stop-color="#00ffcc"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div class="logo-text">
                <span class="logo-title">CREDIT</span>
                <span class="logo-subtitle">MATRIX_</span>
            </div>
        </div>

        <div class="nav-links">
            <a href="javascript:void(0)" class="nav-link active" data-page="dashboard" onclick="App.navigate('dashboard')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="javascript:void(0)" class="nav-link" data-page="upload" onclick="App.navigate('upload')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <span>Upload Report</span>
            </a>
            <a href="javascript:void(0)" class="nav-link" data-page="clients" onclick="App.navigate('clients')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                    <path d="M16 3.13a4 4 0 010 7.75"/>
                </svg>
                <span>Clients</span>
            </a>
            <a href="javascript:void(0)" class="nav-link" data-page="disputes" onclick="App.navigate('disputes')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                <span>// DISPATCHED</span>
            </a>
            <a href="javascript:void(0)" class="nav-link" data-page="templates" onclick="App.navigate('templates')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M3 9h18M9 21V9"/>
                </svg>
                <span>Templates</span>
            </a>
        </div>

        <div class="sidebar-footer">
            <div class="system-status">
                <div class="status-dot"></div>
                <span>SYS_ACTIVE</span>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" id="mainContent">

        <!-- Top Bar -->
        <header class="top-bar">
            <button class="menu-toggle" id="menuToggle" onclick="App.toggleSidebar()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <div class="search-bar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" placeholder="Search clients, disputes, accounts..." id="globalSearch" oninput="App.handleSearch(this.value)">
            </div>
            <div class="top-bar-actions">
                <button class="btn-icon" title="Notifications">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 01-3.46 0"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ========== DASHBOARD PAGE ========== -->
        <section class="page active" id="page-dashboard">
            <div class="page-header">
                <h1>// COMMAND_CENTER</h1>
                <p class="page-desc">> system_overview :: credit repair operations active</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statClients">0</span>
                        <span class="stat-label">Total Clients</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statDisputes">0</span>
                        <span class="stat-label">Active Disputes</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statAccounts">0</span>
                        <span class="stat-label">Accounts Disputed</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon amber">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="statResolved">0</span>
                        <span class="stat-label">Letters Generated</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card recent-clients">
                    <div class="card-header">
                        <h3>// RECENT_AGENTS</h3>
                        <button class="btn-sm" onclick="App.navigate('clients')">View All</button>
                    </div>
                    <div class="card-body" id="recentClientsList">
                        <div class="empty-state-small">
                            <p>> no agents registered. upload credit report to initialize.</p>
                        </div>
                    </div>
                </div>
                <div class="card quick-actions">
                    <div class="card-header">
                        <h3>// QUICK_OPS</h3>
                    </div>
                    <div class="card-body">
                        <button class="action-btn" onclick="App.navigate('upload')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Upload Credit Report
                        </button>
                        <button class="action-btn" onclick="App.navigate('clients')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4-4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <line x1="20" y1="8" x2="20" y2="14"/>
                                <line x1="23" y1="11" x2="17" y2="11"/>
                            </svg>
                            Add New Client
                        </button>
                        <button class="action-btn" onclick="App.navigate('templates')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18M9 21V9"/>
                            </svg>
                            View Templates
                        </button>
                    </div>
                </div>
            </div>

            <div class="card recent-activity">
                <div class="card-header">
                    <h3>// ACTIVITY_LOG</h3>
                </div>
                <div class="card-body" id="recentActivity">
                    <div class="empty-state-small">
                        <p>> no operations logged.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== UPLOAD PAGE ========== -->
        <section class="page" id="page-upload">
            <div class="page-header">
                <h1>// DATA_UPLOAD</h1>
                <p class="page-desc">> initialize scan :: drag and drop credit report PDF</p>
            </div>

            <!-- Client Selection -->
            <div class="card upload-client-select">
                <div class="card-header">
                    <h3>// SELECT_AGENT</h3>
                </div>
                <div class="card-body">
                    <div class="client-select-row">
                        <div class="form-group" style="flex:1">
                            <label>Existing Client</label>
                            <select id="uploadClientSelect" onchange="App.onClientSelectChange()">
                                <option value="">-- Select a client --</option>
                                <option value="new">+ Create New Client</option>
                            </select>
                        </div>
                    </div>
                    <div class="new-client-form" id="newClientForm" style="display:none">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="clientName" placeholder="John Doe">
                            </div>
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="date" id="clientDob">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>SSN (Last 4)</label>
                                <input type="text" id="clientSsn" placeholder="XXXX" maxlength="4">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="clientPhone" placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="clientEmail" placeholder="john@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:2">
                                <label>Street Address *</label>
                                <input type="text" id="clientAddress" placeholder="123 Main St">
                            </div>
                            <div class="form-group">
                                <label>City *</label>
                                <input type="text" id="clientCity" placeholder="Atlanta">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>State *</label>
                                <input type="text" id="clientState" placeholder="GA" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label>Zip *</label>
                                <input type="text" id="clientZip" placeholder="30301" maxlength="10">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drop Zone -->
            <div class="drop-zone-container">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-inner">
                        <div class="drop-icon">
                            <svg viewBox="0 0 80 80" fill="none" width="80" height="80">
                                <rect x="12" y="6" width="36" height="48" rx="2" stroke="url(#upGrad)" stroke-width="1.5"/>
                                <path d="M36 6v12h12" stroke="url(#upGrad)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <text x="18" y="26" font-family="monospace" font-size="7" fill="#00ff41" opacity="0.7">01101</text>
                                <text x="18" y="35" font-family="monospace" font-size="7" fill="#00ff41" opacity="0.5">10010</text>
                                <text x="18" y="44" font-family="monospace" font-size="7" fill="#00ff41" opacity="0.3">11001</text>
                                <path d="M60 54l-8-10-8 10" stroke="#00ff41" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="52" y1="44" x2="52" y2="68" stroke="#00ff41" stroke-width="2.5" stroke-linecap="round"/>
                                <circle cx="52" cy="56" r="16" stroke="url(#upGrad)" stroke-width="1.5" stroke-dasharray="4 3"/>
                                <defs>
                                    <linearGradient id="upGrad" x1="0" y1="0" x2="80" y2="80">
                                        <stop stop-color="#00ff41"/>
                                        <stop offset="1" stop-color="#00ffcc"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <h2 class="drop-title">// UPLOAD_CREDIT_REPORT</h2>
                        <p class="drop-subtitle">[ click or drag file to initialize ]</p>
                        <p class="drop-hint">PDF FILES // ALL THREE BUREAUS SUPPORTED</p>
                        <div class="bureau-badges">
                            <span class="bureau-badge experian">Experian</span>
                            <span class="bureau-badge equifax">Equifax</span>
                            <span class="bureau-badge transunion">TransUnion</span>
                        </div>
                    </div>
                    <div class="drop-zone-border"></div>
                    <input type="file" id="fileInput" accept=".pdf" style="display:none" multiple>
                </div>
            </div>

            <!-- Upload Progress -->
            <div class="card upload-progress" id="uploadProgress" style="display:none">
                <div class="card-body">
                    <div class="progress-header">
                        <span class="progress-title" id="progressTitle">Analyzing credit report...</span>
                        <span class="progress-percent" id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-steps">
                        <div class="progress-step active" id="step1">
                            <div class="step-dot"></div>
                            <span>Extracting Text</span>
                        </div>
                        <div class="progress-step" id="step2">
                            <div class="step-dot"></div>
                            <span>Identifying Info</span>
                        </div>
                        <div class="progress-step" id="step3">
                            <div class="step-dot"></div>
                            <span>Analyzing Accounts</span>
                        </div>
                        <div class="progress-step" id="step4">
                            <div class="step-dot"></div>
                            <span>Complete</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parsed Results -->
            <div id="parsedResults" style="display:none">
                <!-- Personal Info Card -->
                <div class="card parsed-info">
                    <div class="card-header">
                        <h3>// EXTRACTED_DATA</h3>
                        <span class="badge badge-info">Editable</span>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="parsedName">
                            </div>
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="text" id="parsedDob">
                            </div>
                            <div class="form-group">
                                <label>SSN (Last 4)</label>
                                <input type="text" id="parsedSsn" maxlength="4">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:2">
                                <label>Address</label>
                                <input type="text" id="parsedAddress">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="parsedCity">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <input type="text" id="parsedState" maxlength="2">
                            </div>
                            <div class="form-group">
                                <label>Zip</label>
                                <input type="text" id="parsedZip">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Derogatory Accounts -->
                <div class="card parsed-accounts">
                    <div class="card-header">
                        <h3>// FLAGGED_ACCOUNTS</h3>
                        <div class="header-actions">
                            <button class="btn-sm" onclick="App.selectAllAccounts()">Select All</button>
                            <button class="btn-sm btn-outline" onclick="App.deselectAllAccounts()">Deselect All</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="accounts-filter">
                            <button class="filter-btn active" data-filter="all" onclick="App.filterAccounts('all')">All</button>
                            <button class="filter-btn" data-filter="collection" onclick="App.filterAccounts('collection')">Collections</button>
                            <button class="filter-btn" data-filter="late_payment" onclick="App.filterAccounts('late_payment')">Late Payments</button>
                            <button class="filter-btn" data-filter="charge_off" onclick="App.filterAccounts('charge_off')">Charge-Offs</button>
                            <button class="filter-btn" data-filter="public_record" onclick="App.filterAccounts('public_record')">Public Records</button>
                            <button class="filter-btn" data-filter="repossession" onclick="App.filterAccounts('repossession')">Repossessions</button>
                        </div>
                        <div class="accounts-list" id="accountsList">
                            <!-- Populated dynamically -->
                        </div>
                        <div class="accounts-summary" id="accountsSummary">
                        </div>
                    </div>
                </div>

                <!-- Template Selection -->
                <div class="card template-select">
                    <div class="card-header">
                        <h3>// SELECT_PROTOCOL</h3>
                    </div>
                    <div class="card-body">
                        <div class="template-grid" id="templateGrid">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="generate-section">
                    <div class="generate-info">
                        <p>This will generate <strong>3 separate dispute letters</strong> - one for each credit bureau.</p>
                        <div class="bureau-targets">
                            <span class="bureau-target experian">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                Experian
                            </span>
                            <span class="bureau-target equifax">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                Equifax
                            </span>
                            <span class="bureau-target transunion">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                TransUnion
                            </span>
                        </div>
                    </div>
                    <button class="btn-generate" id="btnGenerate" onclick="App.generateLetters()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                        Generate Dispute Letters
                    </button>
                </div>
            </div>
        </section>

        <!-- ========== CLIENTS PAGE ========== -->
        <section class="page" id="page-clients">
            <div class="page-header">
                <h1>// AGENT_DATABASE</h1>
                <p class="page-desc">> manage registered agents :: credit repair network</p>
                <button class="btn-primary" onclick="App.showAddClientModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    ADD_AGENT
                </button>
            </div>

            <div class="clients-toolbar">
                <div class="search-inline">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="text" placeholder="Search clients..." id="clientSearch" oninput="CRM.filterClients(this.value)">
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid" onclick="App.setClientView('grid')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                        </svg>
                    </button>
                    <button class="view-btn" data-view="list" onclick="App.setClientView('list')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18">
                            <line x1="8" y1="6" x2="21" y2="6"/>
                            <line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/>
                            <line x1="3" y1="12" x2="3.01" y2="12"/>
                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="clients-grid" id="clientsGrid">
                <div class="empty-state" id="clientsEmpty">
                    <svg viewBox="0 0 80 80" fill="none" width="80" height="80">
                        <rect x="15" y="10" width="50" height="55" rx="3" stroke="#0a3a0a" stroke-width="1.5"/>
                        <text x="22" y="30" font-family="monospace" font-size="8" fill="#006622">ACCESS</text>
                        <text x="22" y="42" font-family="monospace" font-size="8" fill="#006622">DENIED</text>
                        <circle cx="40" cy="58" r="3" fill="#006622"/>
                    </svg>
                    <h3>// NO_AGENTS_FOUND</h3>
                    <p>> initialize first agent or upload credit report.</p>
                    <button class="btn-primary" onclick="App.navigate('upload')">UPLOAD_REPORT</button>
                </div>
            </div>
        </section>

        <!-- ========== CLIENT DETAIL PAGE ========== -->
        <section class="page" id="page-client-detail">
            <div class="page-header">
                <button class="btn-back" onclick="App.navigate('clients')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="19" y1="12" x2="5" y2="12"/>
                        <polyline points="12 19 5 12 12 5"/>
                    </svg>
                    Back to Clients
                </button>
                <h1 id="clientDetailName">// AGENT_PROFILE</h1>
            </div>

            <div class="client-detail-grid">
                <div class="card client-info-card">
                    <div class="card-header">
                        <h3>// AGENT_INFO</h3>
                        <button class="btn-sm" onclick="App.editClient()">Edit</button>
                    </div>
                    <div class="card-body" id="clientDetailInfo">
                    </div>
                </div>

                <div class="card client-files-card">
                    <div class="card-header">
                        <h3>// UPLOADED_FILES</h3>
                        <button class="btn-sm" onclick="App.uploadForClient()">Upload New</button>
                    </div>
                    <div class="card-body" id="clientDetailFiles">
                    </div>
                </div>

                <div class="card client-letters-card" style="grid-column: 1 / -1">
                    <div class="card-header">
                        <h3>// DISPATCHED</h3>
                    </div>
                    <div class="card-body" id="clientDetailLetters">
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== DISPUTES PAGE ========== -->
        <section class="page" id="page-disputes">
            <div class="page-header">
                <h1>// DISPATCH_CENTER</h1>
                <p class="page-desc">> view and manage all generated dispute packets</p>
            </div>
            <div class="disputes-list" id="disputesList">
                <div class="empty-state">
                    <svg viewBox="0 0 80 80" fill="none" width="80" height="80">
                        <rect x="16" y="8" width="48" height="64" rx="2" stroke="#0a3a0a" stroke-width="1.5"/>
                        <text x="24" y="28" font-family="monospace" font-size="6" fill="#006622" opacity="0.7">NO_DATA</text>
                        <text x="24" y="40" font-family="monospace" font-size="6" fill="#006622" opacity="0.5">EMPTY</text>
                        <text x="24" y="52" font-family="monospace" font-size="6" fill="#006622" opacity="0.3">NULL</text>
                    </svg>
                    <h3>// NO_DISPATCHES_FOUND</h3>
                    <p>> upload credit report and generate dispatch packets.</p>
                    <button class="btn-primary" onclick="App.navigate('upload')">UPLOAD_REPORT</button>
                </div>
            </div>
        </section>

        <!-- ========== TEMPLATES PAGE ========== -->
        <section class="page" id="page-templates">
            <div class="page-header">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                    <div>
                        <h1>// TEMPLATE_VAULT</h1>
                        <p class="page-desc">> access dispute protocols :: select template</p>
                    </div>
                    <button class="btn-primary" onclick="App.showUploadTemplateModal()" style="white-space:nowrap;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="vertical-align:middle;margin-right:6px;">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Upload Custom Template
                    </button>
                </div>
            </div>
            <div class="templates-showcase" id="templatesShowcase">
                <!-- Populated dynamically -->
            </div>
        </section>

        <!-- ========== LETTER PREVIEW PAGE ========== -->
        <section class="page" id="page-letter-preview">
            <div class="page-header">
                <button class="btn-back" onclick="App.navigate('upload')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="19" y1="12" x2="5" y2="12"/>
                        <polyline points="12 19 5 12 12 5"/>
                    </svg>
                    Back
                </button>
                <h1>// OUTPUT_TERMINAL</h1>
            </div>

            <div class="letter-tabs">
                <button class="letter-tab active" data-bureau="experian" onclick="App.switchLetterTab('experian')">
                    <span class="tab-dot experian"></span> Experian
                </button>
                <button class="letter-tab" data-bureau="equifax" onclick="App.switchLetterTab('equifax')">
                    <span class="tab-dot equifax"></span> Equifax
                </button>
                <button class="letter-tab" data-bureau="transunion" onclick="App.switchLetterTab('transunion')">
                    <span class="tab-dot transunion"></span> TransUnion
                </button>
            </div>

            <div class="letter-preview-container">
                <div class="letter-actions-bar">
                    <button class="btn-primary" onclick="App.downloadLetter('current')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download This Letter
                    </button>
                    <button class="btn-secondary" onclick="App.downloadAllLetters()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download All 3 Letters
                    </button>
                    <button class="btn-outline-light" onclick="App.saveToClient()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save to Client File
                    </button>
                </div>
                <div class="letter-paper" id="letterPreview">
                    <!-- Letter content rendered here -->
                </div>
            </div>
        </section>

    </main>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay" onclick="App.closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="modal-close" onclick="App.closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
<script>
/* ============================================
   CREDIT MATRIX - Dispute Letter Templates
   ============================================ */

const DisputeTemplates = {
    templates: [
        {
            id: 'basic_dispute',
            name: 'Basic Dispute Letter',
            description: 'A straightforward dispute letter citing inaccuracies under the FCRA. Requests investigation and removal of unverifiable items.',
            tag: 'Most Popular',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach(acc => {
                    accountList += `\n  - Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Dispute of Inaccurate Credit Report Information

To Whom It May Concern:

I am writing to dispute the following inaccurate information that appears on my credit report. I have identified the items listed below as inaccurate and request that they be investigated and corrected or removed from my credit report pursuant to the Fair Credit Reporting Act (FCRA), Section 611 (15 U.S.C.  1681i).

The following accounts are being reported inaccurately:
${accountList}
I am disputing these items because the information is inaccurate and does not reflect the true status of these accounts. Under the FCRA, you are required to conduct a reasonable investigation into this matter and remove or correct any information that cannot be verified within 30 days of receiving this dispute.

Please investigate these items and provide me with the results of your investigation, including a copy of my updated credit report reflecting any changes made.

I have enclosed a copy of my identification for verification purposes.

Thank you for your prompt attention to this matter.

Sincerely,


${personalInfo.fullName}

Enclosures:
- Copy of Driver's License or State ID
- Copy of Social Security Card or W-2
- Proof of Address (utility bill or bank statement)`;
            }
        },
        {
            id: 'factual_dispute',
            name: 'Factual Dispute Letter',
            description: 'Disputes based on specific factual inaccuracies such as wrong balances, dates, or account statuses. Cites specific FCRA sections.',
            tag: 'Detailed',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach((acc, idx) => {
                    accountList += `\nItem #${idx + 1}:`;
                    accountList += `\n  Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n  Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Formal Dispute - Factually Inaccurate Account Information

To Whom It May Concern:

I am writing to formally dispute factually inaccurate information contained in my credit report maintained by your bureau. Pursuant to the Fair Credit Reporting Act, 15 U.S.C.  1681i, I am exercising my right to dispute incomplete and inaccurate information.

After careful review of my credit report, I have identified the following items that contain factual errors:
${accountList}
As required by Section 611(a) of the FCRA, I am requesting that you conduct a thorough and reasonable investigation of each disputed item listed above. The FCRA requires that credit reporting agencies follow reasonable procedures to assure maximum possible accuracy of the information in consumer credit reports (15 U.S.C.  1681e(b)).

Furthermore, under Section 611(a)(1)(A), you are required to:
1. Conduct a reasonable reinvestigation to determine whether the disputed information is inaccurate
2. Record the current status of the disputed information before the beginning of the 30-day period
3. Forward all relevant information regarding the dispute to the furnisher of information

If you are unable to verify any of the disputed items within 30 days, I request that they be promptly removed from my credit report in accordance with FCRA Section 611(a)(5)(A).

Please forward me an updated copy of my credit report once the investigation is complete.

Respectfully,


${personalInfo.fullName}

Enclosures:
- Copy of Government-Issued Photo ID
- Proof of Current Address
- Copy of Social Security Card`;
            }
        },
        {
            id: 'method_of_verification',
            name: 'Method of Verification (MOV)',
            description: 'Requests the credit bureau to provide the method used to verify disputed accounts. Powerful follow-up letter after initial dispute.',
            tag: 'Follow-Up',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach(acc => {
                    accountList += `\n  - Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Request for Method of Verification - Previously Disputed Items

To Whom It May Concern:

I recently submitted a dispute regarding inaccurate items on my credit report. I received your response stating that the items were "verified." However, I am requesting that you provide me with the method of verification used for each of the following accounts pursuant to FCRA Section 611(a)(6)(B)(iii) and Section 611(a)(7):

The following items were previously disputed and allegedly verified:
${accountList}
Under Section 611(a)(6)(B)(iii) of the Fair Credit Reporting Act, upon the completion of a reinvestigation, the consumer reporting agency shall provide to the consumer a description or notice of the procedure used to determine the accuracy and completeness of the information, including the name, business address, and telephone number of any furnisher contacted in connection with such information.

Additionally, Section 611(a)(7) states that the consumer reporting agency shall provide a description of the reinvestigation procedure used to determine the accuracy and completeness of the information.

I am requesting the following for each disputed account:
1. The name, address, and telephone number of each person contacted regarding each disputed item
2. A description of the method used to verify each item
3. A copy of any documentation obtained during the reinvestigation
4. The dates on which the reinvestigation was conducted

If you are unable to provide this information, then the items have not been properly verified and must be deleted from my credit report immediately under FCRA Section 611(a)(5)(A).

I expect a response within 15 days of receipt of this letter.

Sincerely,


${personalInfo.fullName}

Enclosures:
- Copy of Previous Dispute Response (if available)
- Copy of Government-Issued Photo ID`;
            }
        },
        {
            id: 'debt_validation',
            name: 'Debt Validation Letter',
            description: 'Specifically targets collection accounts. Demands validation of the debt and proof that the collector has the right to collect.',
            tag: 'Collections',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach(acc => {
                    accountList += `\n  - Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Dispute of Unvalidated Collection Accounts

To Whom It May Concern:

I am writing to dispute the following collection accounts appearing on my credit report. I do not recognize these debts and I am requesting that they be properly validated and verified before being reported on my credit file.

The following collection accounts are in dispute:
${accountList}
Under the Fair Credit Reporting Act, Section 611, you are required to conduct a reasonable investigation of items disputed by consumers. Additionally, under Section 1681e(b), every consumer reporting agency shall follow reasonable procedures to assure maximum possible accuracy of the information concerning the individual about whom the report relates.

I am requesting that you verify the following for each disputed collection account:
1. Proof that the collection agency or creditor has the legal authority to collect this debt
2. Verification of the complete payment history and original amount owed
3. Proof that the statute of limitations has not expired on this debt
4. A copy of the original signed contract or agreement bearing my signature
5. Verification that the amount being reported is accurate

If any of the above information cannot be provided or verified within 30 days, I demand that these items be immediately deleted from my credit report as required under FCRA Section 611(a)(5)(A).

Please be advised that reporting unverified information is a violation of the FCRA and may subject your agency to liability under Section 616 and Section 617 of the Act.

Respectfully,


${personalInfo.fullName}

Enclosures:
- Copy of Driver's License or State ID
- Proof of Address`;
            }
        },
        {
            id: 'aggressive_removal',
            name: 'Aggressive Removal Request',
            description: 'A strongly worded letter demanding removal of negative items. References legal consequences of FCRA violations and intent to pursue remedies.',
            tag: 'Aggressive',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach((acc, idx) => {
                    accountList += `\n  ${idx + 1}. Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n     Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: DEMAND FOR IMMEDIATE REMOVAL OF INACCURATE INFORMATION

To Whom It May Concern:

This letter serves as a formal demand for the immediate removal of the following inaccurate, misleading, and unverifiable information from my credit report. I have previously reviewed my credit report and found these items to be in violation of the Fair Credit Reporting Act.

ITEMS TO BE REMOVED IMMEDIATELY:
${accountList}
LEGAL BASIS FOR THIS DEMAND:

1. Under 15 U.S.C.  1681e(b), consumer reporting agencies are required to follow reasonable procedures to assure maximum possible accuracy of consumer credit information. The items listed above fail to meet this standard.

2. Under 15 U.S.C.  1681i(a), you are required to conduct a reasonable reinvestigation and delete information that is found to be inaccurate, incomplete, or unverifiable.

3. Under 15 U.S.C.  1681s-2(b), furnishers of information are required to conduct an investigation when notified of a dispute by a consumer reporting agency.

NOTICE OF INTENT:

Please be advised that if these items are not removed within 30 days of your receipt of this letter, I intend to exercise my rights under the FCRA, including but not limited to:

- Filing a formal complaint with the Consumer Financial Protection Bureau (CFPB)
- Filing a complaint with the Federal Trade Commission (FTC)
- Pursuing statutory damages of $100 to $1,000 per violation under 15 U.S.C.  1681n
- Seeking actual damages for any harm caused by the continued reporting of this inaccurate information
- Recovery of attorney's fees and court costs

I trust this matter will be handled with the seriousness and urgency it deserves.

This letter is being sent via certified mail and I will retain a copy for my records.

Sincerely,


${personalInfo.fullName}

Enclosures:
- Copy of Government-Issued Photo ID
- Copy of Social Security Card
- Proof of Current Address`;
            }
        },
        {
            id: 'early_exclusion',
            name: 'Early Exclusion / Obsolete Data Request',
            description: 'Requests removal of items that are approaching or past the 7-year reporting limit. Challenges the date of first delinquency.',
            tag: 'Timing-Based',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach(acc => {
                    accountList += `\n  - Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Request for Removal of Obsolete / Expired Information

To Whom It May Concern:

I am writing to request the removal of the following items from my credit report that I believe to be obsolete or approaching obsolescence under the Fair Credit Reporting Act, Section 605 (15 U.S.C.  1681c).

The following items are in question:
${accountList}
Under FCRA Section 605(a), the following reporting time limits apply:
- Most negative information: 7 years from the date of first delinquency
- Bankruptcies: 10 years from the date of filing (Chapter 7) or 7 years (Chapter 13)
- Collection accounts: 7 years from the date of first delinquency on the ORIGINAL account

I am requesting that you verify the accuracy of the date of first delinquency for each of these accounts. Under FCRA Section 623(a)(5), the furnisher of information is required to report the date of first delinquency accurately.

If the date of first delinquency cannot be accurately verified, or if these items have exceeded the allowable reporting period, I demand their immediate removal from my credit report.

Please provide me with documentation showing the verified date of first delinquency for each disputed item.

Thank you for your attention to this matter.

Sincerely,


${personalInfo.fullName}

Enclosures:
- Copy of Government-Issued Photo ID
- Proof of Address`;
            }
        },
        {
            id: 'identity_theft',
            name: 'Identity Theft Dispute',
            description: 'For disputing accounts opened fraudulently. Includes FTC identity theft report references and demands under extended fraud alert provisions.',
            tag: 'Fraud',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach(acc => {
                    accountList += `\n  - Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Identity Theft Dispute - Request for Fraudulent Account Removal

To Whom It May Concern:

I am a victim of identity theft and I am writing to dispute the following fraudulent accounts that appear on my credit report. These accounts were opened without my knowledge, consent, or authorization.

FRAUDULENT ACCOUNTS:
${accountList}
Pursuant to the Fair Credit Reporting Act, Section 605B (15 U.S.C.  1681c-2), I am requesting that you block the reporting of any information resulting from identity theft. I have filed the appropriate reports and am enclosing supporting documentation.

Under Section 605B, you are required to:
1. Block the reporting of information resulting from identity theft no later than 4 business days after receiving this notice
2. Notify the furnisher of information that the information may be a result of identity theft
3. Notify the furnisher that the block has been established

Additionally, under Section 609(e), I am requesting that you provide me with copies of all business transaction records related to the fraudulent accounts, including applications and other documents.

I have not authorized anyone to use my personal information to open these accounts, and I demand their immediate removal from my credit file.

Please confirm in writing that these accounts have been removed and provide me with an updated copy of my credit report.

Sincerely,


${personalInfo.fullName}

Enclosures:
- FTC Identity Theft Report / Affidavit
- Copy of Government-Issued Photo ID
- Copy of Social Security Card
- Police Report (if available)
- Proof of Address`;
            }
        },
        {
            id: 'goodwill_removal',
            name: 'Goodwill Adjustment Letter',
            description: 'A polite request to creditors to remove negative marks as a gesture of goodwill. Best for one-time late payments with otherwise good history.',
            tag: 'Goodwill',
            generate: function(data) {
                const { personalInfo, bureau, accounts, date } = data;
                const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                let accountList = '';
                accounts.forEach(acc => {
                    accountList += `\n  - Account Name: ${acc.creditorName}`;
                    if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                    accountList += '\n';
                });

                return `${personalInfo.fullName}
${personalInfo.address}
${personalInfo.city}, ${personalInfo.state} ${personalInfo.zip}
${personalInfo.ssn ? 'SSN: XXX-XX-' + personalInfo.ssn : ''}
${personalInfo.dob ? 'Date of Birth: ' + personalInfo.dob : ''}

Date: ${date}

${bureauAddress.name}
${bureauAddress.address}
${bureauAddress.cityStateZip}

RE: Goodwill Request for Removal of Negative Information

To Whom It May Concern:

I am writing to respectfully request a goodwill adjustment to my credit report maintained by your bureau. I am requesting that the following negative items be considered for removal or updated reporting:
${accountList}
I understand that the reported information may be technically accurate. However, I am requesting this adjustment as a gesture of goodwill based on the following circumstances:

The negative marks on my report were the result of circumstances beyond my normal control. Since that time, I have taken significant steps to ensure my financial responsibilities are met consistently and on time. I have demonstrated a strong commitment to maintaining good credit standing.

This negative information is significantly impacting my ability to obtain favorable credit terms and is not reflective of my current financial responsibility and creditworthiness.

I am not disputing the accuracy of the information, but rather requesting that you consider updating this information as a courtesy based on my overall positive credit history and the steps I have taken to resolve any outstanding issues.

I would greatly appreciate your consideration in this matter.

Thank you for your time and attention.

Respectfully,


${personalInfo.fullName}`;
            }
        }
    ],

    getBureauAddress: function(bureau) {
        const addresses = {
            experian: {
                name: 'Experian',
                address: 'P.O. Box 4500',
                cityStateZip: 'Allen, TX 75013'
            },
            equifax: {
                name: 'Equifax Information Services LLC',
                address: 'P.O. Box 740256',
                cityStateZip: 'Atlanta, GA 30374'
            },
            transunion: {
                name: 'TransUnion LLC',
                address: 'P.O. Box 2000',
                cityStateZip: 'Chester, PA 19016'
            }
        };
        return addresses[bureau] || addresses.experian;
    },

    getTemplate: function(id) {
        // Check built-in templates first
        const builtIn = this.templates.find(t => t.id === id);
        if (builtIn) return builtIn;

        // Check custom templates
        const custom = this.getCustomTemplates().find(t => t.id === id);
        return custom || null;
    },

    getAllTemplates: function() {
        return [...this.templates, ...this.getCustomTemplates()];
    },

    // Custom template management
    getCustomTemplates: function() {
        try {
            const stored = localStorage.getItem('creditdb_custom_templates');
            if (!stored) return [];
            const customs = JSON.parse(stored);
            // Rebuild generate functions from stored template body
            return customs.map(ct => ({
                id: ct.id,
                name: ct.name,
                description: ct.description || 'Custom uploaded template',
                tag: 'Custom',
                isCustom: true,
                templateBody: ct.templateBody,
                generate: function(data) {
                    const { personalInfo, bureau, accounts, date } = data;
                    const bureauAddress = DisputeTemplates.getBureauAddress(bureau);

                    // Build account list
                    let accountList = '';
                    accounts.forEach(acc => {
                        accountList += `\n  - Account Name: ${acc.creditorName}`;
                        if (acc.accountNumber) accountList += `\n    Account Number: ${acc.accountNumber}`;
                        accountList += '\n';
                    });

                    // Replace placeholders in template body
                    let letter = ct.templateBody;
                    letter = letter.replace(/\{NAME\}/g, personalInfo.fullName || '');
                    letter = letter.replace(/\{ADDRESS\}/g, personalInfo.address || '');
                    letter = letter.replace(/\{CITY\}/g, personalInfo.city || '');
                    letter = letter.replace(/\{STATE\}/g, personalInfo.state || '');
                    letter = letter.replace(/\{ZIP\}/g, personalInfo.zip || '');
                    letter = letter.replace(/\{SSN\}/g, personalInfo.ssn ? 'XXX-XX-' + personalInfo.ssn : '');
                    letter = letter.replace(/\{DOB\}/g, personalInfo.dob || '');
                    letter = letter.replace(/\{DATE\}/g, date);
                    letter = letter.replace(/\{BUREAU_NAME\}/g, bureauAddress.name);
                    letter = letter.replace(/\{BUREAU_ADDRESS\}/g, bureauAddress.address);
                    letter = letter.replace(/\{BUREAU_CITY_STATE_ZIP\}/g, bureauAddress.cityStateZip);
                    letter = letter.replace(/\{ACCOUNT_LIST\}/g, accountList);
                    return letter;
                }
            }));
        } catch (e) {
            console.error('Error loading custom templates:', e);
            return [];
        }
    },

    saveCustomTemplate: function(template) {
        try {
            const stored = localStorage.getItem('creditdb_custom_templates');
            const customs = stored ? JSON.parse(stored) : [];
            customs.push({
                id: 'custom_' + Date.now(),
                name: template.name,
                description: template.description || 'Custom uploaded template',
                templateBody: template.templateBody
            });
            localStorage.setItem('creditdb_custom_templates', JSON.stringify(customs));
            return true;
        } catch (e) {
            console.error('Error saving custom template:', e);
            return false;
        }
    },

    deleteCustomTemplate: function(templateId) {
        try {
            const stored = localStorage.getItem('creditdb_custom_templates');
            if (!stored) return;
            let customs = JSON.parse(stored);
            customs = customs.filter(t => t.id !== templateId);
            localStorage.setItem('creditdb_custom_templates', JSON.stringify(customs));
        } catch (e) {
            console.error('Error deleting custom template:', e);
        }
    }
};


/* ============================================
   CREDIT MATRIX - IMPROVED Credit Report PDF Parser
   Handles IdentityIQ Three-Bureau Format
   ============================================ */

const PDFParser = {

    // Set PDF.js worker
    init: function() {
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    },

    // Extract all text from a PDF file with proper line structure
    extractText: async function(file, progressCallback) {
        return new Promise(async (resolve, reject) => {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const totalPages = pdf.numPages;
                let fullText = '';

                for (let i = 1; i <= totalPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const items = textContent.items.filter(it => it.str.length > 0);

                    if (items.length === 0) {
                        fullText += '\n\n';
                        if (progressCallback) progressCallback(Math.round((i / totalPages) * 100));
                        continue;
                    }

                    const firstY = items[0].transform[5];
                    const lastY = items[items.length - 1].transform[5];
                    const yDescending = firstY > lastY;

                    const sorted = [...items].sort((a, b) => {
                        return yDescending
                            ? b.transform[5] - a.transform[5]
                            : a.transform[5] - b.transform[5];
                    });

                    const lineGroups = [];
                    let currentLine = [sorted[0]];
                    let currentLineY = sorted[0].transform[5];

                    for (let j = 1; j < sorted.length; j++) {
                        const item = sorted[j];
                        const y = item.transform[5];
                        const height = item.height || sorted[j - 1].height || 10;
                        const threshold = Math.max(2, height * 0.4);

                        if (Math.abs(y - currentLineY) <= threshold) {
                            currentLine.push(item);
                        } else {
                            lineGroups.push(currentLine);
                            currentLine = [item];
                            currentLineY = y;
                        }
                    }
                    lineGroups.push(currentLine);

                    const pageText = lineGroups.map(lineItems => {
                        lineItems.sort((a, b) => a.transform[4] - b.transform[4]);
                        return lineItems.map(it => it.str).join(' ');
                    }).join('\n');

                    fullText += pageText + '\n\n';

                    if (progressCallback) {
                        progressCallback(Math.round((i / totalPages) * 100));
                    }
                }

                resolve(fullText);
            } catch (err) {
                reject(err);
            }
        });
    },

    // Main parse function
    parseReport: function(rawText) {
        const result = {
            personalInfo: this.extractPersonalInfo(rawText),
            accounts: this.extractDerogatoryAccounts(rawText),
            rawText: rawText
        };
        console.log('[CREDIT MATRIX] Parsed report:', result.accounts.length, 'negative accounts found');
        console.log('[CREDIT MATRIX] Accounts:', result.accounts.map(a => a.creditorName + ' -> ' + a.type));
        return result;
    },

    // ================================================
    // PERSONAL INFO EXTRACTION
    // ================================================
    extractPersonalInfo: function(text) {
        const info = {
            fullName: '',
            address: '',
            city: '',
            state: '',
            zip: '',
            ssn: '',
            dob: ''
        };

        // --- IdentityIQ format: Name appears after "Name:" label ---
        // The PDF table renders "Name:" on a line, then the name values for each bureau
        // Pattern: look for "Name:" followed by a name on the same or next line
        const identityIQName = text.match(/\bName\s*:\s*([A-Z][A-Z\s.'-]{2,40})/i);
        if (identityIQName) {
            info.fullName = this.formatName(identityIQName[1].trim());
        }

        // If that didn't work, try standard patterns
        if (!info.fullName) {
            const namePatterns = [
                /(?:Personal\s+Information|Consumer\s+Information|Report\s+for|Name|Consumer)[:\s]*([A-Z][A-Za-z'-]+(?:\s+[A-Z][A-Za-z'-]+){1,3})/i,
                /^([A-Z][A-Z'-]+(?:\s+[A-Z][A-Z'-]+){1,3})\s*$/m,
            ];
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match && match[1] && !this.isCommonHeader(match[1].trim())) {
                    info.fullName = this.formatName(match[1].trim());
                    break;
                }
            }
        }

        // Extract DOB
        const dobPatterns = [
            /(?:Date\s+of\s+Birth|DOB|Birth\s*Date|Born)[:\s]*(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})/i,
            /(?:Date\s+of\s+Birth|DOB|Birth\s*Date)[:\s]*([A-Za-z]+\s+\d{1,2},?\s+\d{4})/i
        ];
        for (const pattern of dobPatterns) {
            const match = text.match(pattern);
            if (match && match[1]) {
                info.dob = match[1].trim();
                break;
            }
        }

        // Extract SSN (last 4)
        const ssnPatterns = [
            /(?:SSN|Social\s*Security|SS#)[:\s#]*(?:XXX-XX-|xxx-xx-|\*{3}-\*{2}-)(\d{4})/i,
            /(?:SSN|Social\s*Security)[:\s#]*\d{3}-?\d{2}-?(\d{4})/i,
        ];
        for (const pattern of ssnPatterns) {
            const match = text.match(pattern);
            if (match && match[1]) {
                info.ssn = match[1];
                break;
            }
        }

        // Extract Address - IdentityIQ shows "Current Address(es):" then address lines
        const addrMatch = text.match(/(?:Current\s+Address|Address)[^:]*:\s*(\d+[^,\n]{5,60})[,\s]+([A-Za-z\s]{2,30})[,\s]+([A-Z]{2})\s+(\d{5}(?:-\d{4})?)/i);
        if (addrMatch) {
            info.address = addrMatch[1].trim();
            info.city = addrMatch[2].trim();
            info.state = addrMatch[3].trim();
            info.zip = addrMatch[4].trim();
        } else {
            // Fallback: any address-like pattern
            const fallback = text.match(/(\d+\s+[A-Za-z0-9\s.#-]{5,50})\s+([A-Za-z\s]{2,25}),?\s+([A-Z]{2})\s+(\d{5}(?:-\d{4})?)/);
            if (fallback) {
                info.address = fallback[1].trim();
                info.city = fallback[2].trim();
                info.state = fallback[3].trim();
                info.zip = fallback[4].trim();
            }
        }

        return info;
    },

    // ================================================
    // DEROGATORY ACCOUNT EXTRACTION - COMPLETELY REWRITTEN
    // ================================================

    // Master list of negative status indicators
    negativeStatusKeywords: [
        'DEROGATORY', 'COLLECTION', 'CHARGEOFF', 'CHARGE-OFF', 'CHARGE OFF',
        'CHARGED OFF', 'PAST DUE', 'LATE 30', 'LATE 60', 'LATE 90',
        'LATE 120', 'LATE 150', 'LATE 180', '30 DAYS', '60 DAYS', '90 DAYS',
        '120 DAYS', '150 DAYS', '180 DAYS', 'COLLECTION/CHARGEOFF',
        'REPOSSESSION', 'FORECLOSURE', 'BANKRUPTCY', 'JUDGMENT',
        'TAX LIEN', 'SETTLED', 'WRITTEN OFF', 'PROFIT AND LOSS',
        'BAD DEBT', 'UNPAID', 'PLACED FOR COLLECTION',
        'SERIOUSLY PAST DUE', 'VOLUNTARY SURRENDER',
        'PURCHASED BY ANOTHER LENDER', 'TRANSFERRED TO RECOVERY'
    ],

    // Words that indicate comment text is negative
    negativeCommentKeywords: [
        'CHARGED OFF', 'CHARGE OFF', 'BAD DEBT', 'COLLECTION',
        'PLACED FOR COLLECTION', 'PAST DUE', 'PROFIT AND LOSS',
        'UNPAID BALANCE', 'LOSS BY', 'WRITE-OFF', 'WRITE OFF',
        'PURCHASED BY', 'TRANSFERRED', 'ACCOUNT SOLD',
        'SERIOUSLY PAST DUE', 'SUBJECT HAS NOT SATISFIED'
    ],

    // Extract derogatory accounts - primary entry point
    extractDerogatoryAccounts: function(text) {
        // Cut off at inquiries section
        const inquiryStart = this.findSectionStart(text, [
            'Inquiries', 'INQUIRIES', 'Credit Inquiries', 'CREDIT INQUIRIES',
            'Requests Viewed By Others', 'Public Information', 'Public Records'
        ]);
        const accountText = inquiryStart > 0 ? text.substring(0, inquiryStart) : text;

        // Find where "Account History" begins (skip personal info and summary)
        const accountHistoryStart = this.findSectionStart(text, [
            'Account History', 'ACCOUNT HISTORY', 'Account Information',
            'ACCOUNT INFORMATION', 'Trade Lines', 'TRADE LINES'
        ]);

        const workingText = accountHistoryStart > 0
            ? text.substring(accountHistoryStart, inquiryStart > 0 ? inquiryStart : text.length)
            : accountText;

        console.log('[CREDIT MATRIX] Working text length:', workingText.length);
        console.log('[CREDIT MATRIX] Account History starts at:', accountHistoryStart);
        console.log('[CREDIT MATRIX] Inquiries section at:', inquiryStart);

        // STRATEGY 1: IdentityIQ block-based parsing (PRIMARY)
        // This is the most reliable for IdentityIQ three-bureau reports
        let accounts = this.parseIdentityIQBlocks(workingText);
        if (accounts.length > 0) {
            console.log('[CREDIT MATRIX] Strategy 1 (IdentityIQ blocks) found:', accounts.length);
            return this.deduplicateAccounts(accounts);
        }

        // STRATEGY 2: Status field scanning
        accounts = this.parseByStatusFields(workingText);
        if (accounts.length > 0) {
            console.log('[CREDIT MATRIX] Strategy 2 (status fields) found:', accounts.length);
            return this.deduplicateAccounts(accounts);
        }

        // STRATEGY 3: Line-by-line keyword scanning
        accounts = this.parseByLineScanning(workingText);
        if (accounts.length > 0) {
            console.log('[CREDIT MATRIX] Strategy 3 (line scanning) found:', accounts.length);
            return this.deduplicateAccounts(accounts);
        }

        // STRATEGY 4: Broad search
        accounts = this.broadKeywordSearch(accountText);
        console.log('[CREDIT MATRIX] Strategy 4 (broad search) found:', accounts.length);
        return this.deduplicateAccounts(accounts);
    },

    // ================================================
    // STRATEGY 1: IdentityIQ Block-Based Parsing
    // ================================================
    // IdentityIQ reports have a very specific structure:
    // 1. Creditor name on its own line (all caps, like "JEFFERSON CAPITAL SYST")
    // 2. Column headers: "TransUnion  Experian  Equifax"
    // 3. Field rows: "Account Status:  Derogatory  Derogatory  Derogatory"
    // 4. More field rows for balance, payment status, etc.
    // 5. Then "Two-Year payment history" section
    // 6. Next creditor starts

    parseIdentityIQBlocks: function(text) {
        const accounts = [];
        const lines = text.split('\n');

        // First, find all creditor name lines.
        // A creditor name line in IdentityIQ is:
        // - All uppercase (or mostly uppercase)
        // - Not a known field label (Account Status, Payment Status, etc.)
        // - Not a bureau header (TransUnion, Experian, Equifax)
        // - Appears before "TransUnion" and "Account #:" lines
        // - Often followed by a line containing "TransUnion" or bureau headers

        const creditorBlocks = [];
        const fieldLabels = new Set([
            'ACCOUNT #', 'ACCOUNT TYPE', 'ACCOUNT TYPE - DETAIL', 'BUREAU CODE',
            'ACCOUNT STATUS', 'MONTHLY PAYMENT', 'DATE OPENED', 'BALANCE',
            'NO. OF MONTHS', 'HIGH CREDIT', 'CREDIT LIMIT', 'PAST DUE',
            'PAYMENT STATUS', 'LAST REPORTED', 'COMMENTS', 'DATE LAST ACTIVE',
            'DATE OF LAST PAYMENT', 'TWO-YEAR PAYMENT HISTORY', 'LEGEND',
            'MONTH', 'YEAR', 'TRANSUNION', 'EXPERIAN', 'EQUIFAX',
            'ACCOUNT HISTORY', 'BACK TO TOP', 'SUMMARY', 'CREDIT SCORE',
            'PERSONAL INFORMATION', 'INQUIRIES', 'PUBLIC INFORMATION',
            'CREDITOR CONTACTS', 'CREDIT REPORT', 'IDENTITYIQ',
            'QUICK LINKS', 'REFERENCE #', 'REPORT DATE', 'PURCHASE REPORT',
            'PRINT THIS PAGE', 'DOWNLOAD THIS REPORT'
        ]);

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const lineUpper = line.toUpperCase();

            // Skip known field labels and headers
            let isFieldLabel = false;
            for (const label of fieldLabels) {
                if (lineUpper.startsWith(label) || lineUpper === label) {
                    isFieldLabel = true;
                    break;
                }
            }
            if (isFieldLabel) continue;

            // Skip lines that are just numbers, dates, dollar amounts, or status codes
            if (/^[\d\/$,.\-\s%*OK CO CLS]+$/i.test(line)) continue;
            if (/^\d{1,2}\/\d{1,2}\/\d{2,4}/.test(line)) continue;
            if (/^(OK|CO|CLS|N\/A|\-|Legend)$/i.test(line)) continue;

            // Skip payment history month/year rows
            if (/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\b/i.test(line)) continue;
            if (/^\d{2}\s+\d{2}\s+\d{2}/.test(line)) continue; // year rows like "25 25 25 25..."

            // Skip lines that contain "http" or "identityiq"
            if (/http|identityiq|member\./i.test(line)) continue;

            // A creditor name candidate:
            // - Starts with a letter
            // - 3-60 chars
            // - Mostly uppercase letters, may contain numbers, &, ., /, -, spaces, parens
            // - Check if nearby lines contain bureau headers or Account # fields
            if (/^[A-Z]/.test(line) && line.length >= 3 && line.length <= 80) {
                // Check: does this line look like a creditor name?
                // It should NOT contain a colon in the first portion (that would be a field label)
                const colonIdx = line.indexOf(':');
                if (colonIdx >= 0 && colonIdx < 25) continue;

                // Check if upcoming lines (within next 5) contain "TransUnion" or "Account #"
                let looksLikeCreditor = false;
                for (let j = i + 1; j < Math.min(i + 6, lines.length); j++) {
                    const nextLine = lines[j].trim();
                    if (/TransUnion|Experian|Equifax/i.test(nextLine) ||
                        /Account\s*#/i.test(nextLine) ||
                        /Account\s*Type/i.test(nextLine)) {
                        looksLikeCreditor = true;
                        break;
                    }
                }

                if (looksLikeCreditor) {
                    // Found a creditor block start
                    creditorBlocks.push({
                        name: line,
                        startLine: i
                    });
                }
            }
        }

        console.log('[CREDIT MATRIX] Found creditor blocks:', creditorBlocks.map(b => b.name));

        // Now for each creditor block, extract all field data until the next creditor block
        for (let b = 0; b < creditorBlocks.length; b++) {
            const block = creditorBlocks[b];
            const nextBlockStart = b + 1 < creditorBlocks.length
                ? creditorBlocks[b + 1].startLine
                : lines.length;

            // Collect all lines for this block
            const blockLines = lines.slice(block.startLine, nextBlockStart);
            const blockText = blockLines.join('\n');
            const blockUpper = blockText.toUpperCase();

            // Check if this account is negative by examining Account Status and Payment Status
            const isNegative = this.isBlockNegative(blockUpper);

            if (isNegative) {
                // Extract details from the block
                const accountNumber = this.extractFieldValue(blockLines, 'Account #');
                const balance = this.extractFieldValue(blockLines, 'Balance');
                const dateOpened = this.extractFieldValue(blockLines, 'Date Opened');
                const accountStatus = this.extractFieldValue(blockLines, 'Account Status');
                const paymentStatus = this.extractFieldValue(blockLines, 'Payment Status');
                const pastDue = this.extractFieldValue(blockLines, 'Past Due');
                const comments = this.extractFieldValue(blockLines, 'Comments');

                // Determine the specific negative type
                const negType = this.classifyNegativeType(accountStatus, paymentStatus, comments, block.name);

                // Clean up the creditor name - remove "(Original Creditor: ...)" portion for display
                let displayName = block.name;
                const origCreditorMatch = displayName.match(/^(.+?)\s*\(Original Creditor:/i);
                if (origCreditorMatch) {
                    displayName = origCreditorMatch[1].trim();
                }

                // Build status text from available fields
                let statusText = '';
                if (paymentStatus && paymentStatus !== '-' && paymentStatus !== '$0.00') {
                    statusText = paymentStatus;
                } else if (accountStatus && accountStatus !== '-') {
                    statusText = accountStatus;
                }

                accounts.push({
                    creditorName: displayName,
                    originalCreditor: this.extractOriginalCreditor(block.name),
                    accountNumber: this.cleanFieldValue(accountNumber),
                    type: negType,
                    statusText: statusText,
                    accountStatus: accountStatus,
                    paymentStatus: paymentStatus,
                    balance: this.cleanBalance(balance),
                    pastDue: this.cleanBalance(pastDue),
                    dateOpened: this.cleanFieldValue(dateOpened),
                    comments: comments || '',
                    isDerogatory: true,
                    bureaus: this.detectBureaus(blockText)
                });
            }
        }

        return accounts;
    },

    // Check if an account block contains negative indicators
    isBlockNegative: function(blockUpper) {
        // Check Account Status field
        if (/ACCOUNT\s*STATUS[:\s]*/i.test(blockUpper)) {
            if (/DEROGATORY/i.test(blockUpper)) return true;
        }

        // Check Payment Status field
        if (/PAYMENT\s*STATUS[:\s]*/i.test(blockUpper)) {
            if (/COLLECTION/i.test(blockUpper)) return true;
            if (/CHARGEOFF|CHARGE[\s-]?OFF/i.test(blockUpper)) return true;
            if (/LATE\s+\d+\s+DAYS/i.test(blockUpper)) return true;
        }

        // Check for CO (Charge-Off) markers in payment history
        // The pattern "CO CO CO" in the two-year history is a strong indicator
        if (/\bCO\b.*\bCO\b.*\bCO\b/i.test(blockUpper)) return true;

        // Check Comments field for negative indicators
        for (const keyword of this.negativeCommentKeywords) {
            if (blockUpper.includes(keyword)) return true;
        }

        // Check Account Type for collection
        if (/ACCOUNT\s*TYPE[:\s]*.*COLLECTION/i.test(blockUpper)) return true;
        if (/ACCOUNT\s*TYPE\s*-\s*DETAIL[:\s]*.*COLLECTION/i.test(blockUpper)) return true;

        // Check if "Past Due" has a non-zero value
        const pastDueMatch = blockUpper.match(/PAST\s*DUE[:\s]*\$?([\d,]+)/);
        if (pastDueMatch) {
            const amount = parseFloat(pastDueMatch[1].replace(/,/g, ''));
            if (amount > 0) return true;
        }

        return false;
    },

    // Extract a field value from block lines
    // Handles IdentityIQ's multi-column format where field values for 3 bureaus
    // appear on the same line separated by spaces
    extractFieldValue: function(blockLines, fieldName) {
        for (const line of blockLines) {
            const trimmed = line.trim();
            // Match "Field Name:" or "Field Name :" followed by value(s)
            const regex = new RegExp(fieldName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*:\\s*(.+)', 'i');
            const match = trimmed.match(regex);
            if (match) {
                // The value might contain multiple bureau values separated by spaces
                // Return the first non-empty value
                const rawValue = match[1].trim();
                // Split on multiple spaces to get per-bureau values
                const values = rawValue.split(/\s{2,}/).map(v => v.trim()).filter(v => v && v !== '-');
                return values.length > 0 ? values[0] : rawValue;
            }
        }
        return '';
    },

    // Extract original creditor from parenthetical notation
    extractOriginalCreditor: function(name) {
        const match = name.match(/\(Original\s+Creditor:\s*(?:\d+\s+)?(.+?)\)/i);
        return match ? match[1].trim() : '';
    },

    // Clean up a field value
    cleanFieldValue: function(value) {
        if (!value) return '';
        // Remove common noise
        return value.replace(/^[-\s]+/, '').replace(/[-\s]+$/, '').trim();
    },

    // Clean up a balance value
    cleanBalance: function(value) {
        if (!value) return '';
        const match = value.match(/\$?([\d,]+\.?\d{0,2})/);
        if (match) {
            const num = parseFloat(match[1].replace(/,/g, ''));
            if (num === 0) return '$0.00';
            return '$' + match[1];
        }
        return value;
    },

    // Classify the type of negative account
    classifyNegativeType: function(accountStatus, paymentStatus, comments, name) {
        const combined = ((accountStatus || '') + ' ' + (paymentStatus || '') + ' ' + (comments || '') + ' ' + (name || '')).toUpperCase();

        // Collection accounts (including collection agencies)
        if (/COLLECTION/i.test(combined) && !/CHARGEOFF|CHARGE.?OFF/i.test(paymentStatus || '')) {
            return 'collection';
        }

        // Charge-offs
        if (/CHARGEOFF|CHARGE[\s-]?OFF|BAD\s*DEBT|PROFIT\s*AND\s*LOSS|WRITE[\s-]?OFF|COLLECTION\/CHARGEOFF/i.test(combined)) {
            return 'charge_off';
        }

        // Late payments
        if (/LATE|PAST\s*DUE|DELINQUENT|\d+\s*DAYS/i.test(combined)) {
            return 'late_payment';
        }

        // Repossession
        if (/REPOSSESSION|VOLUNTARY\s*SURRENDER|INVOLUNTARY/i.test(combined)) {
            return 'repossession';
        }

        // Public records
        if (/BANKRUPTCY|JUDGMENT|TAX\s*LIEN|FORECLOSURE/i.test(combined)) {
            return 'public_record';
        }

        // If Account Status is "Derogatory" but we can't classify further
        if (/DEROGATORY/i.test(combined)) {
            return 'negative';
        }

        return 'negative';
    },

    // Detect which bureaus report this account
    detectBureaus: function(blockText) {
        const bureaus = [];
        // If the block has column data for each bureau, detect which ones have entries
        if (/TransUnion/i.test(blockText)) bureaus.push('TransUnion');
        if (/Experian/i.test(blockText)) bureaus.push('Experian');
        if (/Equifax/i.test(blockText)) bureaus.push('Equifax');
        return bureaus;
    },

    // ================================================
    // STRATEGY 2: Status Field Scanning
    // (For non-IdentityIQ formats)
    // ================================================
    parseByStatusFields: function(text) {
        const accounts = [];
        const statusPatterns = [
            /Account\s*Status\s*[:;.\-\s]*([^\n]{2,60})/gi,
            /Payment\s*Status\s*[:;.\-\s]*([^\n]{2,60})/gi,
            /Pay\s*Status\s*[:;.\-\s]*([^\n]{2,60})/gi,
        ];

        const statusMatches = [];
        for (const pattern of statusPatterns) {
            let match;
            while ((match = pattern.exec(text)) !== null) {
                const statusValue = match[1].trim().toUpperCase();
                const isNegative = this.negativeStatusKeywords.some(kw => statusValue.includes(kw));
                if (isNegative) {
                    statusMatches.push({
                        position: match.index,
                        statusValue: match[1].trim(),
                        keyword: this.negativeStatusKeywords.find(kw => statusValue.includes(kw))
                    });
                }
            }
        }

        for (const sm of statusMatches) {
            const contextStart = Math.max(0, sm.position - 1000);
            const contextBefore = text.substring(contextStart, sm.position);

            let creditorName = this.extractCreditorFromContext(contextBefore);
            if (creditorName) {
                const contextAfter = text.substring(sm.position, Math.min(text.length, sm.position + 500));
                const fullContext = contextBefore + contextAfter;

                let accountNumber = '';
                const acctMatch = fullContext.match(/(?:Account\s*(?:Number|#|No\.?)|Acct\s*#?)\s*[:;.\-\s]*([A-Za-z0-9*X#-]{3,25})/i);
                if (acctMatch) accountNumber = acctMatch[1].trim();

                accounts.push({
                    creditorName: creditorName,
                    accountNumber: accountNumber,
                    type: this.classifyNegativeType(sm.statusValue, sm.statusValue, '', ''),
                    statusText: sm.statusValue,
                    balance: this.extractNearbyField(text, sm.position, /(?:Balance|Amount)\s*:?\s*\$?([\d,]+\.?\d{0,2})/i),
                    dateOpened: this.extractNearbyField(text, sm.position, /(?:Opened|Date\s*Opened)\s*:?\s*(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})/i),
                    isDerogatory: true
                });
            }
        }

        return accounts;
    },

    // ================================================
    // STRATEGY 3: Line-by-Line Scanning
    // ================================================
    parseByLineScanning: function(text) {
        const accounts = [];
        const lines = text.split(/\n/);
        let currentAccount = null;
        let accountText = '';

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            const lineUpper = line.toUpperCase();

            if (this.isInquiryLine(lineUpper)) continue;

            const creditorMatch = line.match(/^([A-Z][A-Za-z0-9\s&.'\/,-]{2,50})(?:\s{2,}|\t)/);
            if (creditorMatch) {
                if (currentAccount && currentAccount.isDerogatory) {
                    accounts.push(currentAccount);
                }
                currentAccount = {
                    creditorName: creditorMatch[1].trim(),
                    accountNumber: '',
                    type: 'negative',
                    statusText: '',
                    balance: '',
                    dateOpened: '',
                    isDerogatory: false
                };
                accountText = '';
            }

            accountText += ' ' + lineUpper;

            if (currentAccount) {
                for (const keyword of this.negativeStatusKeywords) {
                    if (lineUpper.includes(keyword)) {
                        currentAccount.isDerogatory = true;
                        currentAccount.type = this.classifyNegativeType(keyword, keyword, '', '');
                        currentAccount.statusText = keyword;
                        break;
                    }
                }

                const acctMatch = line.match(/(?:Account|Acct|#)[:\s#]*([A-Za-z0-9*X-]{4,20})/i);
                if (acctMatch) currentAccount.accountNumber = acctMatch[1].trim();

                const balMatch = line.match(/(?:Balance|Amount|Bal)[:\s]*\$?([\d,]+\.?\d{0,2})/i);
                if (balMatch) currentAccount.balance = '$' + balMatch[1];
            }
        }

        if (currentAccount && currentAccount.isDerogatory) {
            accounts.push(currentAccount);
        }

        return accounts;
    },

    // ================================================
    // STRATEGY 4: Broad Keyword Search
    // ================================================
    broadKeywordSearch: function(text) {
        const accounts = [];
        const chunks = text.split(/\n{2,}/);

        for (const chunk of chunks) {
            const chunkUpper = chunk.toUpperCase();
            if (this.isInquiryLine(chunkUpper)) continue;

            let foundKeyword = null;
            for (const kw of this.negativeStatusKeywords) {
                if (chunkUpper.includes(kw)) {
                    foundKeyword = kw;
                    break;
                }
            }

            if (foundKeyword) {
                const creditorName = this.extractCreditorFromChunk(chunk);
                if (creditorName) {
                    const acctMatch = chunk.match(/(?:Account|Acct|#)\s*:?\s*#?\s*([A-Za-z0-9*X-]{4,20})/i);
                    const balMatch = chunk.match(/(?:Balance|Amount|Bal)\s*:?\s*\$?([\d,]+\.?\d{0,2})/i);

                    accounts.push({
                        creditorName: creditorName,
                        accountNumber: acctMatch ? acctMatch[1].trim() : '',
                        type: this.classifyNegativeType(foundKeyword, foundKeyword, '', ''),
                        statusText: foundKeyword,
                        balance: balMatch ? '$' + balMatch[1] : '',
                        isDerogatory: true
                    });
                }
            }
        }

        return accounts;
    },

    // ================================================
    // HELPER METHODS
    // ================================================

    findSectionStart: function(text, sectionNames) {
        let earliest = -1;
        for (const name of sectionNames) {
            const idx = text.indexOf(name);
            if (idx !== -1 && (earliest === -1 || idx < earliest)) {
                earliest = idx;
            }
        }
        return earliest;
    },

    findInquirySection: function(text) {
        return this.findSectionStart(text, [
            'Inquiries', 'INQUIRIES', 'Credit Inquiries',
            'CREDIT INQUIRIES', 'Requests Viewed By Others'
        ]);
    },

    isInquiryLine: function(lineUpper) {
        const terms = ['INQUIRY', 'INQUIRIES', 'PROMOTIONAL',
            'ACCOUNT REVIEW', 'REQUESTS VIEWED', 'SOFT PULL', 'HARD PULL'];
        return terms.some(t => lineUpper.includes(t));
    },

    extractCreditorFromContext: function(contextBefore) {
        const lines = contextBefore.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 0);
        for (let i = lines.length - 1; i >= Math.max(0, lines.length - 20); i--) {
            const line = lines[i];
            const colonIdx = line.indexOf(':');
            if (colonIdx >= 0 && colonIdx < 35) continue;
            if (/^[\d\/$,.\-\s%*]+$/.test(line)) continue;
            if (line.length < 3) continue;
            if (this.isCommonHeader(line)) continue;
            if (/^(Two-Year|Legend|Month|Year|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|OK|CO|CLS|N\/A|\d)/i.test(line)) continue;

            const nameMatch = line.match(/^([A-Z][A-Za-z0-9\s&.'\/,()-]{2,55})$/i);
            if (nameMatch) return nameMatch[1].trim();
        }
        return null;
    },

    extractCreditorFromChunk: function(chunk) {
        const lines = chunk.trim().split('\n');
        for (const line of lines) {
            const trimmed = line.trim();
            if (trimmed.length > 3 && trimmed.length < 60 && /[A-Z]/.test(trimmed.charAt(0))) {
                if (!this.isCommonHeader(trimmed) && !/^(Account|Status|Balance|Date|Payment|Type|Condition)/i.test(trimmed)) {
                    const colonIdx = trimmed.indexOf(':');
                    if (colonIdx >= 0 && colonIdx < 25) continue;
                    return trimmed;
                }
            }
        }
        return null;
    },

    extractNearbyField: function(text, position, regex) {
        const context = text.substring(Math.max(0, position - 300), Math.min(text.length, position + 300));
        const match = context.match(regex);
        return match ? match[1] : '';
    },

    deduplicateAccounts: function(accounts) {
        const seen = new Map();
        return accounts.filter(acc => {
            // Create a normalized key for dedup
            const normalizedName = acc.creditorName.toUpperCase().replace(/[\s\/\-\.]+/g, '');
            const key = normalizedName + '|' + (acc.accountNumber || '').replace(/\*/g, '');

            // Also check for partial name matches (e.g. "JEFFCAPSYS" vs "JEFFERSON CAPITAL SYST")
            let isDupe = seen.has(key);
            if (!isDupe) {
                // Check if any existing account has a similar name and same account number prefix
                for (const [existingKey, existingAcc] of seen) {
                    const existingNorm = existingAcc.creditorName.toUpperCase().replace(/[\s\/\-\.]+/g, '');
                    // If one name starts with the other and account numbers overlap
                    if ((normalizedName.startsWith(existingNorm.substring(0, 8)) ||
                         existingNorm.startsWith(normalizedName.substring(0, 8))) &&
                        acc.accountNumber && existingAcc.accountNumber &&
                        acc.accountNumber.replace(/\*/g, '') === existingAcc.accountNumber.replace(/\*/g, '')) {
                        isDupe = true;
                        break;
                    }
                }
            }

            if (isDupe) return false;
            seen.set(key, acc);
            return true;
        });
    },

    isCommonHeader: function(text) {
        const headers = [
            'CREDIT REPORT', 'PERSONAL INFORMATION', 'CONSUMER INFORMATION',
            'ACCOUNT INFORMATION', 'CREDIT SUMMARY', 'ACCOUNT SUMMARY',
            'PUBLIC RECORDS', 'COLLECTION ACCOUNTS', 'CREDIT INQUIRIES',
            'INQUIRY INFORMATION', 'PERSONAL PROFILE', 'CREDIT HISTORY',
            'EXPERIAN', 'EQUIFAX', 'TRANSUNION', 'TRANS UNION',
            'CREDIT SCORE', 'FICO SCORE', 'VANTAGE SCORE',
            'DATE REPORTED', 'DATE OPENED', 'ACCOUNT STATUS',
            'PAYMENT STATUS', 'PAYMENT HISTORY', 'ACCOUNT DETAILS',
            'POTENTIALLY NEGATIVE', 'NEGATIVE ITEMS', 'SATISFACTORY ACCOUNTS',
            'TWO-YEAR PAYMENT', 'IDENTITYIQ', 'IDENTITY IQ',
            'ACCOUNTS IN GOOD STANDING', 'ACCOUNT HISTORY',
            'CREDIT REPORT -', 'BACK TO TOP', 'CREDITOR CONTACTS',
            'NONE REPORTED', 'RISK FACTORS', 'SCORE SCALE', 'LENDER RANK'
        ];
        return headers.some(h => text.toUpperCase().includes(h));
    },

    formatName: function(name) {
        return name.split(/\s+/).map(part => {
            return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
        }).join(' ');
    },

    getTypeLabel: function(type) {
        const labels = {
            'collection': 'Collection',
            'charge_off': 'Charge-Off',
            'late_payment': 'Late Payment',
            'public_record': 'Public Record',
            'repossession': 'Repossession',
            'negative': 'Negative'
        };
        return labels[type] || 'Negative';
    }
};

// Initialize on load
PDFParser.init();


/* ============================================
   CREDIT MATRIX - CRM Client Management
   ============================================ */

const CRM = {

    STORAGE_KEY: 'creditdb_clients',
    ACTIVITY_KEY: 'creditdb_activity',

    // Get all clients from storage
    getClients: function() {
        try {
            const data = localStorage.getItem(this.STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error('Error reading clients:', e);
            return [];
        }
    },

    // Save clients to storage
    saveClients: function(clients) {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(clients));
        } catch (e) {
            console.error('Error saving clients:', e);
        }
    },

    // Create a new client
    createClient: function(clientData) {
        const clients = this.getClients();
        const client = {
            id: this.generateId(),
            fullName: clientData.fullName || '',
            email: clientData.email || '',
            phone: clientData.phone || '',
            dob: clientData.dob || '',
            ssn: clientData.ssn || '',
            address: clientData.address || '',
            city: clientData.city || '',
            state: clientData.state || '',
            zip: clientData.zip || '',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            reports: [],
            letters: [],
            notes: ''
        };
        clients.push(client);
        this.saveClients(clients);
        this.logActivity('client', `Added new client: ${client.fullName}`);
        return client;
    },

    // Update an existing client
    updateClient: function(clientId, updates) {
        const clients = this.getClients();
        const index = clients.findIndex(c => c.id === clientId);
        if (index !== -1) {
            clients[index] = { ...clients[index], ...updates, updatedAt: new Date().toISOString() };
            this.saveClients(clients);
            return clients[index];
        }
        return null;
    },

    // Delete a client
    deleteClient: function(clientId) {
        let clients = this.getClients();
        const client = clients.find(c => c.id === clientId);
        clients = clients.filter(c => c.id !== clientId);
        this.saveClients(clients);
        if (client) {
            this.logActivity('client', `Removed client: ${client.fullName}`);
        }
    },

    // Get a single client by ID
    getClient: function(clientId) {
        const clients = this.getClients();
        return clients.find(c => c.id === clientId) || null;
    },

    // Add a report to a client
    addReport: function(clientId, reportData) {
        const clients = this.getClients();
        const client = clients.find(c => c.id === clientId);
        if (client) {
            const report = {
                id: this.generateId(),
                fileName: reportData.fileName || 'credit_report.pdf',
                uploadedAt: new Date().toISOString(),
                accountsFound: reportData.accountsFound || 0,
                parsedData: reportData.parsedData || null
            };
            client.reports.push(report);
            client.updatedAt = new Date().toISOString();
            this.saveClients(clients);
            this.logActivity('upload', `Uploaded credit report for ${client.fullName}`);
            return report;
        }
        return null;
    },

    // Add generated letters to a client
    addLetters: function(clientId, lettersData) {
        const clients = this.getClients();
        const client = clients.find(c => c.id === clientId);
        if (client) {
            const letterGroup = {
                id: this.generateId(),
                createdAt: new Date().toISOString(),
                templateName: lettersData.templateName || 'Basic Dispute',
                accountCount: lettersData.accountCount || 0,
                letters: {
                    experian: lettersData.experian || '',
                    equifax: lettersData.equifax || '',
                    transunion: lettersData.transunion || ''
                }
            };
            client.letters.push(letterGroup);
            client.updatedAt = new Date().toISOString();
            this.saveClients(clients);
            this.logActivity('letter', `Generated dispute letters for ${client.fullName}`);
            return letterGroup;
        }
        return null;
    },

    // Search clients by name or email
    searchClients: function(query) {
        const clients = this.getClients();
        const q = query.toLowerCase().trim();
        if (!q) return clients;
        return clients.filter(c =>
            c.fullName.toLowerCase().includes(q) ||
            (c.email && c.email.toLowerCase().includes(q)) ||
            (c.phone && c.phone.includes(q))
        );
    },

    // Filter clients by name
    filterClients: function(query) {
        const filtered = this.searchClients(query);
        App.renderClients(filtered);
    },

    // Get activity log
    getActivity: function() {
        try {
            const data = localStorage.getItem(this.ACTIVITY_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            return [];
        }
    },

    // Log an activity event
    logActivity: function(type, message) {
        try {
            const activities = this.getActivity();
            activities.unshift({
                type: type,
                message: message,
                timestamp: new Date().toISOString()
            });
            // Keep only last 50 activities
            if (activities.length > 50) activities.length = 50;
            localStorage.setItem(this.ACTIVITY_KEY, JSON.stringify(activities));
        } catch (e) {
            console.error('Error logging activity:', e);
        }
    },

    // Get stats for dashboard
    getStats: function() {
        const clients = this.getClients();
        let totalDisputes = 0;
        let totalAccounts = 0;
        let totalLetters = 0;

        clients.forEach(c => {
            totalDisputes += c.letters.length;
            c.letters.forEach(lg => {
                totalAccounts += lg.accountCount;
                totalLetters += 3; // 3 bureaus per letter group
            });
        });

        return {
            clients: clients.length,
            disputes: totalDisputes,
            accounts: totalAccounts,
            letters: totalLetters
        };
    },

    // Generate unique ID
    generateId: function() {
        return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
    },

    // Format date for display
    formatDate: function(isoString) {
        if (!isoString) return '';
        const d = new Date(isoString);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    },

    // Format relative time
    formatRelativeTime: function(isoString) {
        const now = new Date();
        const then = new Date(isoString);
        const diffMs = now - then;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHrs = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHrs < 24) return `${diffHrs}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return CRM.formatDate(isoString);
    },

    // Populate the client dropdown on upload page
    populateClientDropdown: function() {
        const select = document.getElementById('uploadClientSelect');
        if (!select) return;

        // Clear existing options (keep first two)
        while (select.options.length > 2) {
            select.remove(2);
        }

        const clients = this.getClients();
        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.fullName;
            select.appendChild(option);
        });
    },

    // Get initials for avatar
    getInitials: function(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return parts[0].substring(0, 2).toUpperCase();
    }
};


/* ============================================
   CREDIT MATRIX - Letter Generator
   ============================================ */

const LetterGenerator = {

    // Generate dispute letters for all 3 bureaus
    generateAll: function(personalInfo, selectedAccounts, templateId) {
        const template = DisputeTemplates.getTemplate(templateId);
        if (!template) {
            throw new Error('Template not found: ' + templateId);
        }

        const today = new Date();
        const dateStr = today.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        const bureaus = ['experian', 'equifax', 'transunion'];
        const letters = {};

        bureaus.forEach(bureau => {
            letters[bureau] = template.generate({
                personalInfo: personalInfo,
                bureau: bureau,
                accounts: selectedAccounts,
                date: dateStr
            });
        });

        return letters;
    },

    // Generate a PDF from letter text
    generatePDF: function(letterText, bureau, personalInfo) {
        const { jsPDF } = window.jspdf || { jsPDF: window.jsPDF };
        const doc = new jsPDF({
            unit: 'pt',
            format: 'letter'
        });

        const margin = 72; // 1 inch margins
        const pageWidth = doc.internal.pageSize.getWidth();
        const maxWidth = pageWidth - (margin * 2);
        const lineHeight = 16;
        let y = margin;

        doc.setFont('times', 'normal');
        doc.setFontSize(12);

        const lines = letterText.split('\n');

        lines.forEach(line => {
            // Check if we need a new page
            if (y > doc.internal.pageSize.getHeight() - margin) {
                doc.addPage();
                y = margin;
            }

            if (line.trim() === '') {
                y += lineHeight * 0.6;
                return;
            }

            // Handle long lines by wrapping
            const wrappedLines = doc.splitTextToSize(line, maxWidth);
            wrappedLines.forEach(wl => {
                if (y > doc.internal.pageSize.getHeight() - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.text(wl, margin, y);
                y += lineHeight;
            });
        });

        return doc;
    },

    // Download a single letter as PDF
    downloadPDF: function(letterText, bureau, personalInfo) {
        const doc = this.generatePDF(letterText, bureau, personalInfo);
        const name = personalInfo.fullName ? personalInfo.fullName.replace(/\s+/g, '_') : 'Client';
        const fileName = `Dispute_Letter_${this.capitalizeBureau(bureau)}_${name}.pdf`;
        doc.save(fileName);
    },

    // Download all 3 letters
    downloadAllPDFs: function(letters, personalInfo) {
        const bureaus = ['experian', 'equifax', 'transunion'];
        bureaus.forEach(bureau => {
            if (letters[bureau]) {
                // Small delay between downloads to prevent browser blocking
                setTimeout(() => {
                    this.downloadPDF(letters[bureau], bureau, personalInfo);
                }, bureaus.indexOf(bureau) * 500);
            }
        });
    },

    // Render letter as HTML for preview
    renderLetterHTML: function(letterText) {
        if (!letterText) return '<p style="color: #999; text-align: center;">No letter generated.</p>';

        // Escape HTML
        let html = letterText
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');

        // Convert text formatting
        // Bold: text between ** or lines that are all caps headers
        html = html.replace(/^(RE:.*?)$/gm, '<strong>$1</strong>');
        html = html.replace(/^(ITEMS TO BE REMOVED.*?)$/gm, '<strong>$1</strong>');
        html = html.replace(/^(LEGAL BASIS.*?)$/gm, '<strong>$1</strong>');
        html = html.replace(/^(NOTICE OF INTENT.*?)$/gm, '<strong>$1</strong>');
        html = html.replace(/^(FRAUDULENT ACCOUNTS.*?)$/gm, '<strong>$1</strong>');

        // Numbered list items
        html = html.replace(/^(\d+\.)\s/gm, '<strong>$1</strong> ');

        // Bureau names
        html = html.replace(/\b(Experian|Equifax|TransUnion)\b/g, '<strong>$1</strong>');

        // Convert newlines to <br>
        html = html.replace(/\n/g, '<br>');

        // Wrap in styled container
        return `<div style="font-family: 'Times New Roman', Times, serif; font-size: 13px; line-height: 1.7; color: #111;">${html}</div>`;
    },

    // Capitalize bureau name
    capitalizeBureau: function(bureau) {
        const names = {
            experian: 'Experian',
            equifax: 'Equifax',
            transunion: 'TransUnion'
        };
        return names[bureau] || bureau;
    }
};



// ============================================
// CREDIT MATRIX - Matrix Rain Effect
// ============================================
function initMatrixRain() {
    const canvas = document.getElementById('matrixCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    resize();
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&*<>/\\|~012';
    const fontSize = 14;
    let columns = Math.floor(canvas.width / fontSize);
    let drops = [];
    for (let i = 0; i < columns; i++) drops[i] = Math.random() * -100;
    function draw() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = fontSize + 'px monospace';
        for (let i = 0; i < drops.length; i++) {
            const char = chars[Math.floor(Math.random() * chars.length)];
            const x = i * fontSize;
            const y = drops[i] * fontSize;
            const brightness = Math.random();
            if (brightness > 0.96) {
                ctx.fillStyle = '#ffffff';
            } else if (brightness > 0.85) {
                ctx.fillStyle = '#00ff41';
            } else {
                ctx.fillStyle = 'rgba(0, 255, 65, 0.5)';
            }
            ctx.fillText(char, x, y);
            if (y > canvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        }
    }
    setInterval(draw, 50);
    window.addEventListener('resize', function() {
        resize();
        columns = Math.floor(canvas.width / fontSize);
        while (drops.length < columns) drops.push(0);
        drops.length = columns;
    });
}


/* ============================================
   CREDIT MATRIX - Main Application Controller
   ============================================ */

const App = {

    // State
    currentPage: 'dashboard',
    currentClientId: null,
    parsedData: null,
    selectedAccounts: new Set(),
    selectedTemplate: 'basic_dispute',
    generatedLetters: null,
    currentBureau: 'experian',
    clientView: 'grid',

    // Initialize the app
    init: function() {
        initMatrixRain();
        this.initParticles();
        this.initDropZone();
        this.renderDashboard();
        this.renderTemplateGrid();
        this.renderTemplatesShowcase();
        CRM.populateClientDropdown();
        this.navigate('dashboard');
    },

    // ==========================================
    // NAVIGATION
    // ==========================================
    navigate: function(page, data) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

        // Remove active from nav links
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

        // Show target page
        const targetPage = document.getElementById('page-' + page);
        if (targetPage) {
            targetPage.classList.add('active');
        }

        // Set active nav link
        const navLink = document.querySelector(`.nav-link[data-page="${page}"]`);
        if (navLink) navLink.classList.add('active');

        this.currentPage = page;

        // Page-specific initialization
        switch (page) {
            case 'dashboard':
                this.renderDashboard();
                break;
            case 'clients':
                this.renderClients();
                break;
            case 'client-detail':
                if (data) this.renderClientDetail(data);
                break;
            case 'upload':
                CRM.populateClientDropdown();
                break;
            case 'disputes':
                this.renderDisputesList();
                break;
            case 'templates':
                this.renderTemplatesShowcase();
                break;
        }

        // Close sidebar on mobile
        document.getElementById('sidebar').classList.remove('open');

        // Prevent default link behavior
        return false;
    },

    toggleSidebar: function() {
        document.getElementById('sidebar').classList.toggle('open');
    },

    // ==========================================
    // DASHBOARD
    // ==========================================
    renderDashboard: function() {
        const stats = CRM.getStats();
        document.getElementById('statClients').textContent = stats.clients;
        document.getElementById('statDisputes').textContent = stats.disputes;
        document.getElementById('statAccounts').textContent = stats.accounts;
        document.getElementById('statResolved').textContent = stats.letters;

        // Recent clients
        const clients = CRM.getClients().slice(-5).reverse();
        const recentList = document.getElementById('recentClientsList');
        if (clients.length === 0) {
            recentList.innerHTML = '<div class="empty-state-small"><p>No clients yet. Upload a credit report to get started.</p></div>';
        } else {
            recentList.innerHTML = clients.map(c => `
                <div class="activity-item" style="cursor:pointer" onclick="App.navigate('client-detail', '${c.id}')">
                    <div class="client-avatar" style="width:32px;height:32px;font-size:12px;flex-shrink:0">
                        ${CRM.getInitials(c.fullName)}
                    </div>
                    <div class="activity-text">
                        <strong>${this.escapeHtml(c.fullName)}</strong>
                        <span style="margin-left:8px;font-size:11px;color:var(--text-muted)">${c.reports.length} reports, ${c.letters.length} disputes</span>
                    </div>
                    <span class="activity-time">${CRM.formatRelativeTime(c.updatedAt)}</span>
                </div>
            `).join('');
        }

        // Recent activity
        const activities = CRM.getActivity().slice(0, 10);
        const activityList = document.getElementById('recentActivity');
        if (activities.length === 0) {
            activityList.innerHTML = '<div class="empty-state-small"><p>No recent activity.</p></div>';
        } else {
            activityList.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-dot ${a.type}"></div>
                    <span class="activity-text">${this.escapeHtml(a.message)}</span>
                    <span class="activity-time">${CRM.formatRelativeTime(a.timestamp)}</span>
                </div>
            `).join('');
        }
    },

    // ==========================================
    // UPLOAD & PARSING
    // ==========================================
    initDropZone: function() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (!dropZone || !fileInput) return;

        // Click to browse
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.handleFileUpload(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.handleFileUpload(e.target.files[0]);
            }
        });
    },

    onClientSelectChange: function() {
        const select = document.getElementById('uploadClientSelect');
        const newForm = document.getElementById('newClientForm');
        if (select.value === 'new') {
            newForm.style.display = 'block';
        } else {
            newForm.style.display = 'none';
        }
    },

    handleFileUpload: async function(file) {
        if (file.type !== 'application/pdf') {
            this.showToast('Please upload a PDF file.', 'error');
            return;
        }

        // Check client selection
        const clientSelect = document.getElementById('uploadClientSelect');
        if (!clientSelect.value) {
            this.showToast('Please select or create a client first.', 'error');
            return;
        }

        // If creating new client, validate required fields
        if (clientSelect.value === 'new') {
            const name = document.getElementById('clientName').value.trim();
            const address = document.getElementById('clientAddress').value.trim();
            const city = document.getElementById('clientCity').value.trim();
            const state = document.getElementById('clientState').value.trim();
            const zip = document.getElementById('clientZip').value.trim();

            if (!name) {
                this.showToast('Please enter the client\'s full name.', 'error');
                return;
            }
            if (!address || !city || !state || !zip) {
                this.showToast('Please enter the client\'s full address.', 'error');
                return;
            }
        }

        // Show progress
        const progressEl = document.getElementById('uploadProgress');
        const parsedEl = document.getElementById('parsedResults');
        progressEl.style.display = 'block';
        parsedEl.style.display = 'none';

        this.updateProgress(0, 'Extracting text from PDF...', 1);

        try {
            // Extract text from PDF
            const rawText = await PDFParser.extractText(file, (pct) => {
                this.updateProgress(pct * 0.5, 'Extracting text from PDF...', 1);
            });

            this.updateProgress(50, 'Identifying personal information...', 2);
            await this.sleep(300);

            // Parse the report
            const parsed = PDFParser.parseReport(rawText);
            this.parsedData = parsed;

            this.updateProgress(75, 'Analyzing accounts...', 3);
            await this.sleep(300);

            // Handle client creation/selection
            let clientId = clientSelect.value;
            if (clientId === 'new') {
                const client = CRM.createClient({
                    fullName: document.getElementById('clientName').value.trim(),
                    dob: document.getElementById('clientDob').value,
                    ssn: document.getElementById('clientSsn').value.trim(),
                    phone: document.getElementById('clientPhone').value.trim(),
                    email: document.getElementById('clientEmail').value.trim(),
                    address: document.getElementById('clientAddress').value.trim(),
                    city: document.getElementById('clientCity').value.trim(),
                    state: document.getElementById('clientState').value.trim(),
                    zip: document.getElementById('clientZip').value.trim()
                });
                clientId = client.id;
                this.currentClientId = clientId;

                // Override parsed personal info with manually entered info
                parsed.personalInfo.fullName = client.fullName || parsed.personalInfo.fullName;
                parsed.personalInfo.dob = client.dob || parsed.personalInfo.dob;
                parsed.personalInfo.ssn = client.ssn || parsed.personalInfo.ssn;
                parsed.personalInfo.address = client.address || parsed.personalInfo.address;
                parsed.personalInfo.city = client.city || parsed.personalInfo.city;
                parsed.personalInfo.state = client.state || parsed.personalInfo.state;
                parsed.personalInfo.zip = client.zip || parsed.personalInfo.zip;
            } else {
                this.currentClientId = clientId;
                const existingClient = CRM.getClient(clientId);
                if (existingClient) {
                    // Fill personal info from existing client data
                    parsed.personalInfo.fullName = existingClient.fullName || parsed.personalInfo.fullName;
                    parsed.personalInfo.dob = existingClient.dob || parsed.personalInfo.dob;
                    parsed.personalInfo.ssn = existingClient.ssn || parsed.personalInfo.ssn;
                    parsed.personalInfo.address = existingClient.address || parsed.personalInfo.address;
                    parsed.personalInfo.city = existingClient.city || parsed.personalInfo.city;
                    parsed.personalInfo.state = existingClient.state || parsed.personalInfo.state;
                    parsed.personalInfo.zip = existingClient.zip || parsed.personalInfo.zip;
                }
            }

            // Save report to client
            CRM.addReport(clientId, {
                fileName: file.name,
                accountsFound: parsed.accounts.length,
                parsedData: {
                    personalInfo: parsed.personalInfo,
                    accountCount: parsed.accounts.length
                }
            });

            this.updateProgress(100, 'Analysis complete!', 4);
            await this.sleep(500);

            // Populate the results
            this.populateParsedResults(parsed);

            // Select all accounts by default
            this.selectedAccounts = new Set(parsed.accounts.map((_, i) => i));

            progressEl.style.display = 'none';
            parsedEl.style.display = 'block';

            this.showToast(`Found ${parsed.accounts.length} derogatory account(s).`, 'success');

        } catch (err) {
            console.error('PDF parsing error:', err);
            progressEl.style.display = 'none';
            this.showToast('Error parsing PDF: ' + err.message, 'error');
        }
    },

    updateProgress: function(percent, title, step) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
        document.getElementById('progressTitle').textContent = title;

        for (let i = 1; i <= 4; i++) {
            const stepEl = document.getElementById('step' + i);
            stepEl.classList.remove('active', 'done');
            if (i < step) stepEl.classList.add('done');
            if (i === step) stepEl.classList.add('active');
        }
    },

    populateParsedResults: function(parsed) {
        // Fill personal info fields
        document.getElementById('parsedName').value = parsed.personalInfo.fullName || '';
        document.getElementById('parsedDob').value = parsed.personalInfo.dob || '';
        document.getElementById('parsedSsn').value = parsed.personalInfo.ssn || '';
        document.getElementById('parsedAddress').value = parsed.personalInfo.address || '';
        document.getElementById('parsedCity').value = parsed.personalInfo.city || '';
        document.getElementById('parsedState').value = parsed.personalInfo.state || '';
        document.getElementById('parsedZip').value = parsed.personalInfo.zip || '';

        // Render accounts
        this.renderAccountsList(parsed.accounts);

        // Render template selection
        this.renderTemplateGrid();
    },

    renderAccountsList: function(accounts, filter) {
        const container = document.getElementById('accountsList');
        const summary = document.getElementById('accountsSummary');

        if (!accounts || accounts.length === 0) {
            container.innerHTML = `
                <div class="empty-state-small">
                    <p>No derogatory accounts were automatically detected. You can manually add accounts or try uploading a different format.</p>
                </div>`;
            summary.innerHTML = '';
            return;
        }

        const filteredAccounts = filter && filter !== 'all'
            ? accounts.filter(a => a.type === filter)
            : accounts;

        container.innerHTML = filteredAccounts.map((acc, idx) => {
            const realIdx = accounts.indexOf(acc);
            const isSelected = this.selectedAccounts.has(realIdx);
            return `
                <div class="account-item ${isSelected ? '' : 'deselected'}" data-index="${realIdx}" data-type="${acc.type}">
                    <div class="account-checkbox">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="App.toggleAccount(${realIdx})">
                    </div>
                    <div class="account-details">
                        <div class="account-name">${this.escapeHtml(acc.creditorName)}</div>
                        <div class="account-meta">
                            ${acc.accountNumber ? `<span>Acct: ${this.escapeHtml(acc.accountNumber)}</span>` : ''}
                            ${acc.balance ? `<span>Balance: ${this.escapeHtml(acc.balance)}</span>` : ''}
                            ${acc.dateOpened ? `<span>Opened: ${this.escapeHtml(acc.dateOpened)}</span>` : ''}
                            ${acc.statusText ? `<span>Status: ${this.escapeHtml(acc.statusText)}</span>` : ''}
                        </div>
                    </div>
                    <span class="account-type-badge ${acc.type}">${PDFParser.getTypeLabel(acc.type)}</span>
                </div>
            `;
        }).join('');

        const selectedCount = this.selectedAccounts.size;
        summary.innerHTML = `
            <span><span class="selected-count">${selectedCount}</span> of ${accounts.length} accounts selected for dispute</span>
            <span style="color: var(--text-muted); font-size: 12px">Inquiries excluded</span>
        `;
    },

    toggleAccount: function(index) {
        if (this.selectedAccounts.has(index)) {
            this.selectedAccounts.delete(index);
        } else {
            this.selectedAccounts.add(index);
        }
        if (this.parsedData) {
            this.renderAccountsList(this.parsedData.accounts,
                document.querySelector('.filter-btn.active')?.dataset?.filter);
        }
    },

    selectAllAccounts: function() {
        if (this.parsedData) {
            this.selectedAccounts = new Set(this.parsedData.accounts.map((_, i) => i));
            this.renderAccountsList(this.parsedData.accounts,
                document.querySelector('.filter-btn.active')?.dataset?.filter);
        }
    },

    deselectAllAccounts: function() {
        this.selectedAccounts.clear();
        if (this.parsedData) {
            this.renderAccountsList(this.parsedData.accounts,
                document.querySelector('.filter-btn.active')?.dataset?.filter);
        }
    },

    filterAccounts: function(filter) {
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });

        if (this.parsedData) {
            this.renderAccountsList(this.parsedData.accounts, filter);
        }
    },

    // ==========================================
    // TEMPLATES
    // ==========================================
    renderTemplateGrid: function() {
        const grid = document.getElementById('templateGrid');
        if (!grid) return;

        const templates = DisputeTemplates.getAllTemplates();
        grid.innerHTML = templates.map(t => `
            <div class="template-card ${this.selectedTemplate === t.id ? 'selected' : ''} ${t.isCustom ? 'custom-template' : ''}"
                 onclick="App.selectTemplate('${t.id}')">
                <h4>${this.escapeHtml(t.name)}</h4>
                <p>${this.escapeHtml(t.description)}</p>
                <span class="template-tag ${t.isCustom ? 'tag-custom' : ''}">${this.escapeHtml(t.tag)}</span>
            </div>
        `).join('');
    },

    selectTemplate: function(templateId) {
        this.selectedTemplate = templateId;
        this.renderTemplateGrid();
    },

    renderTemplatesShowcase: function() {
        const container = document.getElementById('templatesShowcase');
        if (!container) return;

        const templates = DisputeTemplates.getAllTemplates();
        container.innerHTML = templates.map(t => {
            // Generate a preview snippet with dummy data
            const previewText = t.generate({
                personalInfo: { fullName: '[Client Name]', address: '[Address]', city: '[City]', state: '[ST]', zip: '[ZIP]', ssn: '1234', dob: '01/01/1990' },
                bureau: 'experian',
                accounts: [{ creditorName: '[Creditor Name]', accountNumber: 'XXXX1234', type: 'collection', statusText: 'Collection', balance: '$500', dateOpened: '01/2020' }],
                date: 'January 1, 2025'
            });

            const deleteBtn = t.isCustom ? `<button class="btn-sm" style="color:var(--accent-red);border-color:var(--accent-red);margin-left:8px;" onclick="event.stopPropagation();App.deleteCustomTemplate('${t.id}')">Delete</button>` : '';

            return `
                <div class="showcase-card">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h3>${this.escapeHtml(t.name)}</h3>
                        ${deleteBtn}
                    </div>
                    <p>${this.escapeHtml(t.description)}</p>
                    <span class="badge ${t.tag === 'Most Popular' ? 'badge-info' : t.tag === 'Aggressive' ? 'badge-danger' : t.tag === 'Custom' ? 'badge-custom' : 'badge-warning'}">${this.escapeHtml(t.tag)}</span>
                    <div class="preview-snippet" style="margin-top: 12px">
                        ${this.escapeHtml(previewText.substring(0, 300))}...
                    </div>
                </div>
            `;
        }).join('');
    },

    // ==========================================
    // CUSTOM TEMPLATE UPLOAD
    // ==========================================
    showUploadTemplateModal: function() {
        document.getElementById('modalTitle').textContent = 'Upload Custom Template';
        document.getElementById('modalBody').innerHTML = `
            <div class="form-group">
                <label>Template Name *</label>
                <input type="text" id="customTemplateName" placeholder="e.g. My Custom Dispute Letter">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="customTemplateDesc" placeholder="Brief description of this template">
            </div>
            <div class="form-group">
                <label>Template Body *</label>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
                    Use these placeholders: {NAME}, {ADDRESS}, {CITY}, {STATE}, {ZIP}, {SSN}, {DOB}, {DATE}, {BUREAU_NAME}, {BUREAU_ADDRESS}, {BUREAU_CITY_STATE_ZIP}, {ACCOUNT_LIST}
                </p>
                <textarea id="customTemplateBody" rows="16" style="width:100%;font-family:monospace;font-size:12px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border-color);border-radius:var(--radius);padding:12px;resize:vertical;" placeholder="{NAME}
{ADDRESS}
{CITY}, {STATE} {ZIP}

Date: {DATE}

{BUREAU_NAME}
{BUREAU_ADDRESS}
{BUREAU_CITY_STATE_ZIP}

RE: Dispute Letter

To Whom It May Concern:

I am writing to dispute the following accounts:
{ACCOUNT_LIST}

[Your letter body here...]

Sincerely,

{NAME}"></textarea>
            </div>
            <div class="form-group">
                <label>Or Upload a Text File</label>
                <input type="file" id="customTemplateFile" accept=".txt,.text" style="color:var(--text-primary);" onchange="App.loadTemplateFile(event)">
            </div>
            <div class="modal-actions">
                <button class="btn-outline-light" onclick="App.closeModal()">Cancel</button>
                <button class="btn-primary" onclick="App.saveCustomTemplate()">Save Template</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('active');
    },

    loadTemplateFile: function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('customTemplateBody').value = e.target.result;
        };
        reader.readAsText(file);
    },

    saveCustomTemplate: function() {
        const name = document.getElementById('customTemplateName').value.trim();
        const desc = document.getElementById('customTemplateDesc').value.trim();
        const body = document.getElementById('customTemplateBody').value.trim();

        if (!name) {
            this.showToast('Please enter a template name.', 'error');
            return;
        }
        if (!body) {
            this.showToast('Please enter the template body or upload a text file.', 'error');
            return;
        }

        const success = DisputeTemplates.saveCustomTemplate({
            name: name,
            description: desc || 'Custom template',
            templateBody: body
        });

        if (success) {
            this.closeModal();
            this.renderTemplatesShowcase();
            this.renderTemplateGrid();
            this.showToast('Custom template "' + name + '" saved successfully!', 'success');
        } else {
            this.showToast('Error saving template.', 'error');
        }
    },

    deleteCustomTemplate: function(templateId) {
        if (confirm('Are you sure you want to delete this custom template?')) {
            DisputeTemplates.deleteCustomTemplate(templateId);
            this.renderTemplatesShowcase();
            this.renderTemplateGrid();
            if (this.selectedTemplate === templateId) {
                this.selectedTemplate = 'basic_dispute';
            }
            this.showToast('Custom template deleted.', 'info');
        }
    },

    // ==========================================
    // LETTER GENERATION
    // ==========================================
    generateLetters: function() {
        if (!this.parsedData) {
            this.showToast('No credit report data. Please upload a report first.', 'error');
            return;
        }

        if (this.selectedAccounts.size === 0) {
            this.showToast('Please select at least one account to dispute.', 'error');
            return;
        }

        // Gather current personal info from the form
        const personalInfo = {
            fullName: document.getElementById('parsedName').value.trim(),
            address: document.getElementById('parsedAddress').value.trim(),
            city: document.getElementById('parsedCity').value.trim(),
            state: document.getElementById('parsedState').value.trim(),
            zip: document.getElementById('parsedZip').value.trim(),
            ssn: document.getElementById('parsedSsn').value.trim(),
            dob: document.getElementById('parsedDob').value.trim()
        };

        if (!personalInfo.fullName) {
            this.showToast('Please enter the client\'s name.', 'error');
            return;
        }

        // Get selected accounts
        const selectedAccts = this.parsedData.accounts.filter((_, i) => this.selectedAccounts.has(i));

        try {
            this.generatedLetters = LetterGenerator.generateAll(personalInfo, selectedAccts, this.selectedTemplate);
            this.currentBureau = 'experian';

            // Show letter preview page
            this.navigate('letter-preview');
            this.renderLetterPreview();

            // Update client info if needed
            if (this.currentClientId) {
                CRM.updateClient(this.currentClientId, {
                    fullName: personalInfo.fullName,
                    address: personalInfo.address,
                    city: personalInfo.city,
                    state: personalInfo.state,
                    zip: personalInfo.zip,
                    ssn: personalInfo.ssn,
                    dob: personalInfo.dob
                });
            }

            const templateObj = DisputeTemplates.getTemplate(this.selectedTemplate);
            CRM.logActivity('letter', `Generated ${templateObj.name} for ${personalInfo.fullName} (${selectedAccts.length} accounts)`);

            this.showToast('Dispute letters generated successfully!', 'success');
        } catch (err) {
            console.error('Letter generation error:', err);
            this.showToast('Error generating letters: ' + err.message, 'error');
        }
    },

    renderLetterPreview: function() {
        if (!this.generatedLetters) return;

        const preview = document.getElementById('letterPreview');
        preview.innerHTML = LetterGenerator.renderLetterHTML(this.generatedLetters[this.currentBureau]);

        // Update tabs
        document.querySelectorAll('.letter-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.bureau === this.currentBureau);
        });
    },

    switchLetterTab: function(bureau) {
        this.currentBureau = bureau;
        this.renderLetterPreview();
    },

    downloadLetter: function(which) {
        if (!this.generatedLetters) return;

        const personalInfo = {
            fullName: document.getElementById('parsedName')?.value || ''
        };

        const bureau = which === 'current' ? this.currentBureau : which;
        LetterGenerator.downloadPDF(this.generatedLetters[bureau], bureau, personalInfo);
        this.showToast(`Downloading ${LetterGenerator.capitalizeBureau(bureau)} letter...`, 'info');
    },

    downloadAllLetters: function() {
        if (!this.generatedLetters) return;

        const personalInfo = {
            fullName: document.getElementById('parsedName')?.value || ''
        };

        LetterGenerator.downloadAllPDFs(this.generatedLetters, personalInfo);
        this.showToast('Downloading all 3 dispute letters...', 'info');
    },

    saveToClient: function() {
        if (!this.generatedLetters || !this.currentClientId) {
            this.showToast('No client selected or no letters generated.', 'error');
            return;
        }

        const templateObj = DisputeTemplates.getTemplate(this.selectedTemplate);
        const selectedAccts = this.parsedData.accounts.filter((_, i) => this.selectedAccounts.has(i));

        CRM.addLetters(this.currentClientId, {
            templateName: templateObj.name,
            accountCount: selectedAccts.length,
            experian: this.generatedLetters.experian,
            equifax: this.generatedLetters.equifax,
            transunion: this.generatedLetters.transunion
        });

        this.showToast('Letters saved to client file.', 'success');
    },

    // ==========================================
    // CLIENTS / CRM
    // ==========================================
    renderClients: function(clientsList) {
        const clients = clientsList || CRM.getClients();
        const grid = document.getElementById('clientsGrid');

        if (clients.length === 0) {
            grid.innerHTML = '<div class="empty-state">' +
                '<svg viewBox="0 0 80 80" fill="none" width="80" height="80">' +
                '<circle cx="40" cy="30" r="16" stroke="#3a3a5c" stroke-width="2"/>' +
                '<path d="M16 68c0-13.255 10.745-24 24-24s24 10.745 24 24" stroke="#3a3a5c" stroke-width="2"/>' +
                '</svg>' +
                '<h3>No Clients Yet</h3>' +
                '<p>Add your first client or upload a credit report to get started.</p>' +
                '<button class="btn-primary" onclick="App.navigate(\'upload\')">Upload Credit Report</button>' +
                '</div>';
            return;
        }

        grid.className = `clients-grid ${this.clientView === 'list' ? 'list-view' : ''}`;

        grid.innerHTML = clients.map(c => `
            <div class="client-card" onclick="App.navigate('client-detail', '${c.id}')">
                <div class="client-card-header">
                    <div class="client-avatar">${CRM.getInitials(c.fullName)}</div>
                    <div>
                        <div class="client-card-name">${this.escapeHtml(c.fullName)}</div>
                        <div class="client-card-email">${this.escapeHtml(c.email || c.phone || 'No contact info')}</div>
                    </div>
                </div>
                <div class="client-card-stats">
                    <div class="client-stat">
                        <span class="client-stat-value">${c.reports.length}</span>
                        <span class="client-stat-label">Reports</span>
                    </div>
                    <div class="client-stat">
                        <span class="client-stat-value">${c.letters.length}</span>
                        <span class="client-stat-label">Disputes</span>
                    </div>
                    <div class="client-stat">
                        <span class="client-stat-value">${CRM.formatRelativeTime(c.updatedAt)}</span>
                        <span class="client-stat-label">Last Updated</span>
                    </div>
                </div>
            </div>
        `).join('');
    },

    setClientView: function(view) {
        this.clientView = view;
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === view);
        });
        this.renderClients();
    },

    showAddClientModal: function() {
        document.getElementById('modalTitle').textContent = 'Add New Client';
        document.getElementById('modalBody').innerHTML = `
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="modalClientName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" id="modalClientDob">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>SSN (Last 4)</label>
                    <input type="text" id="modalClientSsn" maxlength="4" placeholder="1234">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="modalClientPhone" placeholder="(555) 123-4567">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="modalClientEmail" placeholder="john@example.com">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:2">
                    <label>Street Address</label>
                    <input type="text" id="modalClientAddress" placeholder="123 Main St">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="modalClientCity" placeholder="Atlanta">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>State</label>
                    <input type="text" id="modalClientState" maxlength="2" placeholder="GA">
                </div>
                <div class="form-group">
                    <label>Zip</label>
                    <input type="text" id="modalClientZip" maxlength="10" placeholder="30301">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-outline-light" onclick="App.closeModal()">Cancel</button>
                <button class="btn-primary" onclick="App.saveNewClient()">Add Client</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('active');
    },

    saveNewClient: function() {
        const name = document.getElementById('modalClientName').value.trim();
        if (!name) {
            this.showToast('Please enter the client\'s name.', 'error');
            return;
        }

        CRM.createClient({
            fullName: name,
            dob: document.getElementById('modalClientDob').value,
            ssn: document.getElementById('modalClientSsn').value.trim(),
            phone: document.getElementById('modalClientPhone').value.trim(),
            email: document.getElementById('modalClientEmail').value.trim(),
            address: document.getElementById('modalClientAddress').value.trim(),
            city: document.getElementById('modalClientCity').value.trim(),
            state: document.getElementById('modalClientState').value.trim(),
            zip: document.getElementById('modalClientZip').value.trim()
        });

        this.closeModal();
        this.renderClients();
        this.showToast(`Client "${name}" added successfully.`, 'success');
    },

    renderClientDetail: function(clientId) {
        const client = CRM.getClient(clientId);
        if (!client) {
            this.navigate('clients');
            return;
        }

        this.currentClientId = clientId;
        document.getElementById('clientDetailName').textContent = client.fullName;

        // Client info
        const infoEl = document.getElementById('clientDetailInfo');
        infoEl.innerHTML = `
            <div class="info-row"><span class="info-label">Name</span><span class="info-value">${this.escapeHtml(client.fullName)}</span></div>
            <div class="info-row"><span class="info-label">Email</span><span class="info-value">${this.escapeHtml(client.email || '-')}</span></div>
            <div class="info-row"><span class="info-label">Phone</span><span class="info-value">${this.escapeHtml(client.phone || '-')}</span></div>
            <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value">${this.escapeHtml(client.dob || '-')}</span></div>
            <div class="info-row"><span class="info-label">SSN (Last 4)</span><span class="info-value">${client.ssn ? 'XXX-XX-' + this.escapeHtml(client.ssn) : '-'}</span></div>
            <div class="info-row"><span class="info-label">Address</span><span class="info-value">${this.escapeHtml(client.address || '-')}${client.city ? ', ' + this.escapeHtml(client.city) : ''}${client.state ? ', ' + this.escapeHtml(client.state) : ''} ${this.escapeHtml(client.zip || '')}</span></div>
            <div class="info-row"><span class="info-label">Added</span><span class="info-value">${CRM.formatDate(client.createdAt)}</span></div>
        `;

        // Reports
        const filesEl = document.getElementById('clientDetailFiles');
        if (client.reports.length === 0) {
            filesEl.innerHTML = '<div class="empty-state-small"><p>No credit reports uploaded yet.</p></div>';
        } else {
            filesEl.innerHTML = client.reports.map(r => `
                <div class="file-item">
                    <div class="file-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <div>
                            <div class="file-name">${this.escapeHtml(r.fileName)}</div>
                            <div class="file-date">${CRM.formatDate(r.uploadedAt)} - ${r.accountsFound} derogatory accounts found</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Letters
        const lettersEl = document.getElementById('clientDetailLetters');
        if (client.letters.length === 0) {
            lettersEl.innerHTML = '<div class="empty-state-small"><p>No dispute letters generated yet.</p></div>';
        } else {
            lettersEl.innerHTML = client.letters.map(lg => `
                <div class="letter-item">
                    <div class="letter-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <div>
                            <div class="letter-name">${this.escapeHtml(lg.templateName)} (${lg.accountCount} accounts)</div>
                            <div class="letter-date">${CRM.formatDate(lg.createdAt)} - Experian, Equifax, TransUnion</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-sm" onclick="App.viewSavedLetter('${client.id}', '${lg.id}', 'experian')">EXP</button>
                        <button class="btn-sm" onclick="App.viewSavedLetter('${client.id}', '${lg.id}', 'equifax')">EQF</button>
                        <button class="btn-sm" onclick="App.viewSavedLetter('${client.id}', '${lg.id}', 'transunion')">TU</button>
                        <button class="btn-sm btn-outline" onclick="App.downloadSavedLetters('${client.id}', '${lg.id}')">Download All</button>
                    </div>
                </div>
            `).join('');
        }
    },

    viewSavedLetter: function(clientId, letterGroupId, bureau) {
        const client = CRM.getClient(clientId);
        if (!client) return;

        const lg = client.letters.find(l => l.id === letterGroupId);
        if (!lg) return;

        this.generatedLetters = lg.letters;
        this.currentBureau = bureau;
        this.navigate('letter-preview');
        this.renderLetterPreview();
    },

    downloadSavedLetters: function(clientId, letterGroupId) {
        const client = CRM.getClient(clientId);
        if (!client) return;

        const lg = client.letters.find(l => l.id === letterGroupId);
        if (!lg) return;

        LetterGenerator.downloadAllPDFs(lg.letters, { fullName: client.fullName });
        this.showToast('Downloading all 3 letters...', 'info');
    },

    editClient: function() {
        const client = CRM.getClient(this.currentClientId);
        if (!client) return;

        document.getElementById('modalTitle').textContent = 'Edit Client';
        document.getElementById('modalBody').innerHTML = `
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="editClientName" value="${this.escapeAttr(client.fullName)}">
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" id="editClientDob" value="${this.escapeAttr(client.dob)}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>SSN (Last 4)</label>
                    <input type="text" id="editClientSsn" maxlength="4" value="${this.escapeAttr(client.ssn)}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="editClientPhone" value="${this.escapeAttr(client.phone)}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editClientEmail" value="${this.escapeAttr(client.email)}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:2">
                    <label>Street Address</label>
                    <input type="text" id="editClientAddress" value="${this.escapeAttr(client.address)}">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="editClientCity" value="${this.escapeAttr(client.city)}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>State</label>
                    <input type="text" id="editClientState" maxlength="2" value="${this.escapeAttr(client.state)}">
                </div>
                <div class="form-group">
                    <label>Zip</label>
                    <input type="text" id="editClientZip" maxlength="10" value="${this.escapeAttr(client.zip)}">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-outline-light" style="color: var(--accent-red); border-color: var(--accent-red);" onclick="App.confirmDeleteClient('${client.id}')">Delete Client</button>
                <div style="flex:1"></div>
                <button class="btn-outline-light" onclick="App.closeModal()">Cancel</button>
                <button class="btn-primary" onclick="App.saveEditClient()">Save Changes</button>
            </div>
        `;
        document.getElementById('modalOverlay').classList.add('active');
    },

    saveEditClient: function() {
        const name = document.getElementById('editClientName').value.trim();
        if (!name) {
            this.showToast('Name is required.', 'error');
            return;
        }

        CRM.updateClient(this.currentClientId, {
            fullName: name,
            dob: document.getElementById('editClientDob').value,
            ssn: document.getElementById('editClientSsn').value.trim(),
            phone: document.getElementById('editClientPhone').value.trim(),
            email: document.getElementById('editClientEmail').value.trim(),
            address: document.getElementById('editClientAddress').value.trim(),
            city: document.getElementById('editClientCity').value.trim(),
            state: document.getElementById('editClientState').value.trim(),
            zip: document.getElementById('editClientZip').value.trim()
        });

        this.closeModal();
        this.renderClientDetail(this.currentClientId);
        this.showToast('Client updated.', 'success');
    },

    confirmDeleteClient: function(clientId) {
        if (confirm('Are you sure you want to delete this client? This will also remove all their reports and dispute letters.')) {
            CRM.deleteClient(clientId);
            this.closeModal();
            this.navigate('clients');
            this.showToast('Client deleted.', 'info');
        }
    },

    uploadForClient: function() {
        // Navigate to upload page with client pre-selected
        this.navigate('upload');
        setTimeout(() => {
            const select = document.getElementById('uploadClientSelect');
            if (select && this.currentClientId) {
                select.value = this.currentClientId;
            }
        }, 100);
    },

    // ==========================================
    // DISPUTES LIST
    // ==========================================
    renderDisputesList: function() {
        const clients = CRM.getClients();
        const container = document.getElementById('disputesList');
        let hasLetters = false;
        let html = '';

        clients.forEach(client => {
            if (client.letters.length > 0) {
                hasLetters = true;
                html += `
                    <div class="dispute-group">
                        <div class="dispute-group-header">
                            <h3>${this.escapeHtml(client.fullName)}</h3>
                            <button class="btn-sm" onclick="App.navigate('client-detail', '${client.id}')">View Client</button>
                        </div>
                        <div class="dispute-group-body">
                            ${client.letters.map(lg => `
                                <div class="letter-item">
                                    <div class="letter-info">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                        </svg>
                                        <div>
                                            <div class="letter-name">${this.escapeHtml(lg.templateName)} - ${lg.accountCount} accounts</div>
                                            <div class="letter-date">${CRM.formatDate(lg.createdAt)}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn-sm" onclick="App.viewSavedLetter('${client.id}', '${lg.id}', 'experian')">View</button>
                                        <button class="btn-sm btn-outline" onclick="App.downloadSavedLetters('${client.id}', '${lg.id}')">Download</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        });

        if (!hasLetters) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 80 80" fill="none" width="80" height="80">
                        <rect x="16" y="8" width="48" height="64" rx="4" stroke="#3a3a5c" stroke-width="2"/>
                        <line x1="26" y1="24" x2="54" y2="24" stroke="#3a3a5c" stroke-width="2"/>
                        <line x1="26" y1="34" x2="54" y2="34" stroke="#3a3a5c" stroke-width="2"/>
                        <line x1="26" y1="44" x2="44" y2="44" stroke="#3a3a5c" stroke-width="2"/>
                    </svg>
                    <h3>No Dispute Letters Yet</h3>
                    <p>Upload a credit report and generate dispute letters to see them here.</p>
                    <button class="btn-primary" onclick="App.navigate('upload')">Upload Credit Report</button>
                </div>`;
        } else {
            container.innerHTML = html;
        }
    },

    // ==========================================
    // SEARCH
    // ==========================================
    handleSearch: function(query) {
        if (!query.trim()) return;
        // Search across clients and navigate to clients page with results
        const results = CRM.searchClients(query);
        this.navigate('clients');
        this.renderClients(results);
        document.getElementById('clientSearch').value = query;
    },

    // ==========================================
    // MODAL
    // ==========================================
    closeModal: function() {
        document.getElementById('modalOverlay').classList.remove('active');
    },

    // ==========================================
    // TOAST NOTIFICATIONS
    // ==========================================
    showToast: function(message, type) {
        type = type || 'info';
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'toastOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    },

    // ==========================================
    // VISUAL EFFECTS
    // ==========================================
    initParticles: function() {
        const container = document.getElementById('particles');
        if (!container) return;

        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDuration = (5 + Math.random() * 10) + 's';
            particle.style.animationDelay = Math.random() * 8 + 's';
            particle.style.width = (1 + Math.random() * 2) + 'px';
            particle.style.height = particle.style.width;

            // Random color between cyan and purple
            if (Math.random() > 0.5) {
                particle.style.background = '#00ff41';
            } else {
                particle.style.background = '#00ffcc';
            }

            container.appendChild(particle);
        }
    },

    // ==========================================
    // UTILITIES
    // ==========================================
    escapeHtml: function(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },

    escapeAttr: function(str) {
        if (!str) return '';
        return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    },

    sleep: function(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});


</script>
</body>
</html>
